#!/bin/bash
# Graft - LLM-powered documentation pipeline
# This is a template wrapper for dependent repositories

set -euo pipefail

# Find graft directory relative to this repo
# Default: assume graft is a sibling directory
GRAFT_DIR="${GRAFT_DIR:-$(dirname "$(dirname "$(realpath "$0")")")/../graft}"

if [ ! -d "$GRAFT_DIR" ]; then
  echo "Error: Cannot find graft directory at $GRAFT_DIR" >&2
  echo "Set GRAFT_DIR environment variable to point to graft repo" >&2
  echo "Example: GRAFT_DIR=/path/to/graft $0 $*" >&2
  exit 1
fi

# Check if Docker image exists
if ! docker image inspect graft:local >/dev/null 2>&1; then
  echo "Error: graft:local image not found" >&2
  echo "Build it first: cd $GRAFT_DIR && make build" >&2
  exit 1
fi

# Run graft Docker image
# Mount AWS credentials from host for SSO/profile support
AWS_DIR="${HOME}/.aws"
AWS_MOUNT=""
AWS_ENV_ARGS=""

if [ -d "$AWS_DIR" ]; then
  AWS_MOUNT="-v ${AWS_DIR}:/root/.aws:ro"
fi

# Pass through AWS environment variables from host if they exist
# This supports both SSO and direct credentials
for var in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_PROFILE AWS_DEFAULT_PROFILE; do
  if [ -n "${!var:-}" ]; then
    AWS_ENV_ARGS="$AWS_ENV_ARGS -e $var"
  fi
done

exec docker run --rm \
  -v "$(pwd):/work" \
  -v "$GRAFT_DIR/scripts:/usr/local/lib/graft:ro" \
  $AWS_MOUNT \
  $AWS_ENV_ARGS \
  --env-file .env \
  graft:local \
  "$@"
