---
status: working
date: 2026-02-12
context: Phase 3 Medium Priority - Documentation & Organization Plan
---

# Phase 3: Medium Priority Improvements - Implementation Plan

## Summary

**Status**: Planning complete, ready to implement
**Estimated Duration**: 1h 40min
**Priority**: Medium (Documentation, organization, testing)
**Blockers**: None (Phase 1 & 2 complete ✅)

---

## Goals

Improve project organization and documentation quality:
1. **Document domain types** - Spec for Grove's Command, CommandState types
2. **Organize scratch documents** - Clean root directory per meta-knowledge-base
3. **Add TUI state tests** - Test coverage for UI state management

---

## Task Breakdown

### Task 3.1: Organize Scratch Documents (20 min)

**Problem**: Root directory cluttered with temporary documents

**Current State**:
```
Root directory (17 markdown files):
- continue-here.md (session handoff)
- FINAL-SUMMARY.md (status bar work)
- grove-status-bar-design.md
- grove-status-bar-test.md
- grove-tui-test-guide.md
- IMPLEMENTATION-COMPLETE.md
- implementation-status.md
- pr-description.md
- STATUS-BAR-CRITIQUE.md
- STATUS-BAR-IMPLEMENTATION.md
- STATUS-BAR-IMPROVEMENTS-PLAN.md
- STATUS-BAR-SUMMARY.md
- tasks.md
- template-status.md
```

**Target State**: Meta-knowledge-base temporal layers
- **Durable** (`docs/`) - Specifications, architecture, decisions
- **Tracking** (`status/`) - Implementation progress, roadmap
- **Ephemeral** (`notes/`) - Session logs, exploration

**Implementation Plan**:

1. **Archive status bar work** (complete, historical):
   ```bash
   mv STATUS-BAR-*.md notes/archive/2026-02-12-status-bar/
   mv grove-status-bar-*.md notes/archive/2026-02-12-status-bar/
   mv FINAL-SUMMARY.md notes/archive/2026-02-12-status-bar/
   mv IMPLEMENTATION-COMPLETE.md notes/archive/2026-02-12-status-bar/
   ```

2. **Archive old session/status files**:
   ```bash
   mv implementation-status.md notes/archive/
   mv pr-description.md notes/archive/
   mv template-status.md notes/archive/
   ```

3. **Keep active files**:
   - `continue-here.md` - Keep in root (active session handoff)
   - `tasks.md` - Keep in root (active task tracking)

4. **Update .gitignore**:
   ```gitignore
   # Temporary scratch files (move to notes/ before committing)
   *-WIP.md
   *-SCRATCH.md
   *-TODO.md
   ```

**Verification**:
```bash
ls -la *.md | grep -v README.md | grep -v CLAUDE.md | grep -v AGENTS.md
# Should show only: continue-here.md, tasks.md
```

**Acceptance Criteria**:
- [ ] Root directory has ≤ 5 markdown files (README, CLAUDE, AGENTS, continue-here, tasks)
- [ ] Status bar work archived in notes/archive/2026-02-12-status-bar/
- [ ] Old session files archived in notes/archive/
- [ ] Documentation follows meta-knowledge-base patterns

**Estimated Effort**: 20 minutes (increased from 10 min for thorough archiving)

---

### Task 3.2: Document Grove Domain Types (30 min)

**Problem**: No specification for Grove's domain types (Command, CommandState, GraftYaml)

**Current State**:
- Grove has domain types in `grove-core/src/domain.rs`
- No specification documenting their structure, validation, or relationship to Graft
- Inconsistent with graft specification patterns

**Solution**: Create `docs/specifications/grove/domain-models.md`

**Content Structure**:

```markdown
# Grove Domain Models

## Command

Represents an executable command from a repository's graft.yaml.

### Structure
- `run: String` - Shell command to execute (required, max 10KB)
- `description: Option<String>` - Human-readable description (max 500 chars)
- `working_dir: Option<String>` - Relative path from repo root
- `env: Option<HashMap<String, String>>` - Environment variables

### Validation Rules
- `run` must not be empty
- `run` max length: 10KB (10,240 bytes)
- `description` max length: 500 characters
- `working_dir` must be relative path (no `/` prefix, no `..` allowed)
- `env` values must be valid UTF-8 strings
- `env` keys must be valid environment variable names

### Relationship to Graft
Grove's Command is a **read-only subset** of graft's Command model.
- Grove parses graft.yaml but delegates execution to `graft run`
- Grove does not modify or persist commands
- Schema must match graft's Command schema exactly

### Example
```yaml
commands:
  test:
    run: pytest tests/
    description: Run test suite
    working_dir: src/
    env:
      PYTEST_VERBOSE: "1"
```

## CommandState

Represents the execution state of a command in the TUI.

### States
```rust
pub enum CommandState {
    NotStarted,
    Running,
    Completed { exit_code: i32 },
    Failed { error: String },
}
```

### Transitions
```
NotStarted -> Running  (when command spawned)
Running -> Completed   (when process exits with code)
Running -> Failed      (when spawn fails or error occurs)
```

### Validation
- `exit_code` can be any i32 (including negative for signals)
- `error` should be human-readable message with recovery suggestions

## GraftYaml

Represents the parsed contents of a repository's graft.yaml file.

### Structure
- `name: String` - Repository name
- `description: Option<String>` - Repository description
- `commands: HashMap<String, Command>` - Available commands

### Validation
- Must have apiVersion field (handled by parser)
- `name` required, max 100 characters
- `commands` can be empty but must be valid HashMap

### Relationship to Graft Specification
Aligns with [Graft YAML Format](../../graft/graft-yaml-format.md)
```

**Files to Create**:
- `docs/specifications/grove/domain-models.md` (new)

**Acceptance Criteria**:
- [ ] Specification created
- [ ] All domain types documented
- [ ] Validation rules specified
- [ ] Relationship to Graft explained
- [ ] Examples provided

**Estimated Effort**: 30 minutes

---

### Task 3.3: Add TUI State Tests (50 min)

**Problem**: Command execution UI state not covered by tests

**Current State**:
- Integration tests cover subprocess communication
- No tests for TUI state transitions
- Command picker, output pane, scrolling untested

**Solution**: Add unit tests in `grove/src/tui_tests.rs`

**Tests to Add**:

1. **test_command_picker_state**
   - Loading commands populates list
   - Selection works (up/down/enter)
   - Empty list handled

2. **test_output_pane_scrolling**
   - Scroll up/down works
   - Scroll bounds enforced
   - Scroll adjusts after ring buffer drain

3. **test_command_state_transitions**
   - NotStarted → Running
   - Running → Completed
   - Running → Failed
   - Proper cleanup on state change

4. **test_confirmation_dialog_state**
   - show_stop_confirmation flag toggles
   - Dialog shows only when running
   - 'y'/'n'/Esc handled correctly

5. **test_ring_buffer_scroll_adjustment**
   - Scroll position adjusted after drain
   - Scroll stays in bounds
   - Truncation marker visible

6. **test_pid_tracking**
   - PID captured on Started event
   - PID cleared on completion
   - PID used for cancellation

**Implementation Approach**:

```rust
// In grove/src/tui_tests.rs (add to existing tests)

#[cfg(test)]
mod command_execution_tests {
    use super::*;

    #[test]
    fn test_command_state_transitions() {
        let registry = MockRegistry::new();
        let detail_provider = MockDetailProvider::new();
        let mut app = App::new(registry, detail_provider, "test".to_string());

        // Initial state
        assert!(matches!(app.command_state, CommandState::NotStarted));

        // Simulate command start
        app.command_state = CommandState::Running;
        assert!(matches!(app.command_state, CommandState::Running));

        // Simulate completion
        app.command_state = CommandState::Completed { exit_code: 0 };
        assert!(matches!(app.command_state, CommandState::Completed { exit_code: 0 }));
    }

    // ... more tests
}
```

**Acceptance Criteria**:
- [ ] 6 new tests added to tui_tests.rs
- [ ] All tests pass
- [ ] State transitions covered
- [ ] Edge cases tested
- [ ] Test coverage >90% for command execution code

**Estimated Effort**: 50 minutes

---

## Implementation Order

### Step 1: Task 3.1 - Organize Scratch Documents (20 min) ✅ EASY WIN
**Rationale**: Simplest task, immediate visible improvement

1. Create archive directories
2. Move status bar documents
3. Move old session files
4. Update .gitignore
5. Verify root is clean

**Expected Duration**: 20 minutes
**Risk**: Low
**Impact**: Medium (cleaner repo)

---

### Step 2: Task 3.2 - Document Domain Types (30 min) ⚠️ MODERATE
**Rationale**: Medium complexity, important for maintainability

1. Read existing domain.rs to understand types
2. Create domain-models.md specification
3. Document Command, CommandState, GraftYaml
4. Add validation rules
5. Add examples

**Expected Duration**: 30 minutes
**Risk**: Low
**Impact**: Medium (better documentation)

---

### Step 3: Task 3.3 - Add TUI State Tests (50 min) ⚠️ MODERATE
**Rationale**: Most complex, requires careful testing

1. Add command_execution_tests module
2. Implement 6 tests systematically
3. Run tests, fix any issues
4. Verify coverage

**Expected Duration**: 50 minutes
**Risk**: Medium (tests might reveal bugs)
**Impact**: High (better test coverage)

---

## Risk Assessment

### Low Risk
- ✅ Task 3.1 (Organize docs) - File operations only
- ✅ Task 3.2 (Document types) - Documentation only

### Medium Risk
- ⚠️ Task 3.3 (TUI tests) - May reveal state management issues

### Mitigation Strategies

**For Task 3.3 (TUI tests)**:
- Start with simplest tests (state transitions)
- Test incrementally (one test at a time)
- If bugs found, fix immediately
- Document any issues discovered

---

## Testing Strategy

### After Each Task

**Task 3.1 (Organize)**:
```bash
# Verify root directory clean
ls -la *.md | wc -l
# Should be ≤ 7 (README, CLAUDE, AGENTS, continue-here, tasks + 2 buffer)

# Verify archives exist
ls notes/archive/2026-02-12-status-bar/
ls notes/archive/
```

**Task 3.2 (Document)**:
```bash
# Verify spec created
cat docs/specifications/grove/domain-models.md

# Verify links work
grep -r "domain-models.md" docs/
```

**Task 3.3 (Tests)**:
```bash
# Run all Grove tests
cargo test --quiet

# Verify new tests pass
cargo test command_execution_tests --quiet

# Check coverage (optional)
cargo tarpaulin --out Stdout
```

---

## Success Criteria

### Functional
- [ ] Root directory organized (≤ 5 active markdown files)
- [ ] Domain types documented with specifications
- [ ] 6 new TUI state tests passing
- [ ] All existing tests still pass

### Quality
- [ ] Documentation follows meta-knowledge-base patterns
- [ ] Specifications complete with validation rules
- [ ] Tests cover edge cases
- [ ] No regressions

### Process
- [ ] Each task tested independently
- [ ] Quick review after each task
- [ ] Comprehensive review at end

---

## Deliverable

**Version**: Continued v0.3.0 improvements
**Tag**: Documentation and testing polish
**Status**: Better organized, better documented, better tested

**Release Notes**:
```
Phase 3: Medium Priority Improvements

- Organized root directory per meta-knowledge-base patterns
- Added Grove domain model specifications
- Added TUI state tests for command execution

Documentation:
- Domain types now have formal specifications
- Status bar work archived to notes/
- Clean project structure

Testing:
- 6 new TUI state tests
- Better coverage for command execution
- State transition testing
```

---

## Comparison to Original Plan

**Original Estimate** (from critique):
- Task 3.1: Document domain types (30 min)
- Task 3.2: Organize docs (10 min)
- Task 3.3: Add TUI tests (1 hour)
- **Total**: 1h 40min

**Updated Estimate** (this plan):
- Task 3.1: Organize docs (20 min) - swapped order
- Task 3.2: Document domain types (30 min)
- Task 3.3: Add TUI tests (50 min)
- **Total**: 1h 40min

**Changes**:
- Swapped task order (organize first = quick win)
- Adjusted organize time (20 min for thorough archiving)
- Reduced test time (50 min, focus on most valuable tests)

---

## Timeline

**Start**: After Phase 2 commit
**Estimated End**: +1h 40min

| Task | Duration | Cumulative |
|------|----------|------------|
| 3.1 Organize docs | 20 min | 20 min |
| 3.2 Document types | 30 min | 50 min |
| 3.3 TUI tests | 50 min | 1h 40min |
| **Total** | **1h 40min** | |

**Buffer**: +20 min for unexpected issues (realistic: 2h)

---

## Next Steps

1. ✅ Planning complete (this document)
2. ⏭️ Implement Task 3.1 (organize docs) - 20 min
3. ⏭️ Quick review of Task 3.1
4. ⏭️ Implement Task 3.2 (document types) - 30 min
5. ⏭️ Quick review of Task 3.2
6. ⏭️ Implement Task 3.3 (TUI tests) - 50 min
7. ⏭️ Comprehensive Phase 3 review
8. ⏭️ Commit Phase 3 work

---

## Sources

- [Command Dispatch Critique](2026-02-12-command-dispatch-critique.md) - Issues #6, #7, #8
- [Improvement Plan](2026-02-12-command-dispatch-improvements-plan.md) - Phase 3 tasks
- [Meta Knowledge Base](../.graft/meta-knowledge-base/docs/policies/temporal-layers.md) - Organization patterns
- [Grove Domain Types](../grove/crates/grove-core/src/domain.rs) - Current implementation
