<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=f5bcd5f14cc03e1a4a914e04edf66588f11f77984ef86b6f428d7b10662a4dd9 | rev=39b5c7a | 2025-11-04 -->
# Command Reference

All Graft commands run through the `bin/graft` wrapper script, which handles Docker image execution and environment setup. If no command is specified, `rebuild` runs by default. For conceptual information about how Graft works, see [how-it-works.md](how-it-works.md).

## Core Commands

### init

```bash
bin/graft init
```

Initialize Graft in your project. This command sets up the complete infrastructure needed to run Graft:

- Installs Git hooks for automatic DVC stage tracking
- Creates a `.env` file template for AWS credentials
- Initializes DVC in the repository
- Configures DVC to use your S3 remote storage

Run this once when adding Graft to a new project. After initialization, edit `.env` to add your AWS credentials before running other commands.

**When to use**: First-time setup in a new repository.

### rebuild

```bash
bin/graft rebuild
```

The default command that performs a complete pipeline execution. This command:

- Regenerates `dvc.yaml` from all prompt files in the project
- Runs the full DVC pipeline (`dvc repro`)
- Processes all stages that have changes (source files, prompts, or dependencies)
- Generates or updates documentation based on detected changes

Each stage receives a change directive (GENERATE, UPDATE, RESTYLE, REFRESH, or MAINTAIN) based on what changed. See [how-it-works.md](how-it-works.md) for details on change detection.

**When to use**: After editing source files, prompts, or dependencies. This is your primary workflow command.

### sync

```bash
bin/graft sync
```

Regenerates `dvc.yaml` from prompt files without executing the pipeline. This command:

- Scans all prompt files to build the stage dependency graph
- Updates `dvc.yaml` with current stage definitions
- Validates configuration and dependencies
- Does not run DVC or generate any documents

Useful for validating your configuration before committing to a full pipeline run.

**When to use**: Check configuration validity, preview pipeline changes, or update `dvc.yaml` without regenerating documents.

**Alias**: `bin/graft check` runs the same operation.

### status

```bash
bin/graft status
```

Shows the current state of the DVC pipeline by running `dvc status`. Displays:

- Which stages have changed and need regeneration
- What dependencies triggered each change
- Whether the pipeline is up to date

**When to use**: Check what will regenerate before running `rebuild`, or verify the pipeline is current after changes.

## Document Management

### new

```bash
bin/graft new <stage_name> <target_path>
```

Scaffolds a new prompt file with a complete template structure. Creates `prompts/<stage_name>.md` containing:

- YAML frontmatter with `deps`, `outs`, and `model` fields
- Placeholder sections for source diff and style prompt
- Comments explaining each section's purpose

**Examples:**

```bash
# Create a new API reference document
bin/graft new api-reference docs/api-reference.md

# Create a troubleshooting guide
bin/graft new troubleshooting docs/troubleshooting.md

# Create a tutorial
bin/graft new getting-started docs/tutorials/getting-started.md
```

After running `new`:
1. Edit the generated `prompts/<stage_name>.md` file
2. Add source dependencies to the `deps` list
3. Write your style prompt instructions
4. Run `bin/graft rebuild` to generate the document

**When to use**: Starting a new documentation file in your project.

## Inspection & Debugging

### diff

```bash
bin/graft diff <stage_name>
```

Displays the complete packed prompt context that will be sent to Claude for a specific stage. Shows:

- The system prompt with change analysis
- Previous draft content
- Source file diffs
- Style prompt instructions

This reveals exactly what context the AI receives, helping you understand why a document was generated or updated in a particular way.

**Example:**

```bash
bin/graft diff command-reference
```

**When to use**: Debug unexpected generation results, verify what sources are included, or understand why a document changed.

### uses

```bash
bin/graft uses <file_path>
```

Performs reverse dependency lookup to show which prompt stages depend on a specific file. Lists all stages that would regenerate if you modify the file.

**Examples:**

```bash
# See what depends on a source file
bin/graft uses src/core/pipeline.py

# Check impact of editing a markdown doc
bin/graft uses docs/configuration.md

# Find dependents of a config file
bin/graft uses pyproject.toml
```

**When to use**: Before editing a file, check what documentation will regenerate. Helps understand the impact of source changes and plan your work.

## Environment & Configuration

The `bin/graft` wrapper accepts environment variables and passes them to the Docker container:

- **DOCFLOW_DIR** - Override the Graft installation location (default: detected automatically)
- **AWS credentials** - Multiple authentication methods supported (see below)

### AWS Credentials

Graft supports three authentication methods in order of preference:

1. **AWS directory mount** (recommended) - Your `~/.aws` directory is automatically mounted, supporting AWS profiles, SSO sessions, and credential files
2. **Environment variables** - Set `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`, `AWS_REGION`, `AWS_DEFAULT_REGION`
3. **`.env` file** - Place credentials in `.env` at project root

See [configuration.md](configuration.md) for detailed credential setup instructions.

## Exit Codes

Graft commands return standard exit codes:

- **0** - Success - Command completed without errors
- **1** - Error - Command failed due to:
  - Missing dependencies in prompt files
  - AWS authentication failure
  - Invalid DVC configuration
  - Pipeline execution errors
  - File not found or permission issues
- **2** - Docker image not found or invalid command specified

## Common Workflows

### 1. Add a new document

```bash
# Create the prompt file
bin/graft new architecture docs/architecture.md

# Edit prompts/architecture.md to add dependencies and instructions
vim prompts/architecture.md

# Generate the document
bin/graft rebuild
```

### 2. Update dependencies

```bash
# Add a new source file to the deps list in frontmatter
vim prompts/api-reference.md

# Rebuild to regenerate with new sources
bin/graft rebuild
```

This triggers an UPDATE action - only semantic changes from the new source are applied.

### 3. Change prompt instructions

```bash
# Modify the style prompt section
vim prompts/command-reference.md

# Rebuild to regenerate with new instructions
bin/graft rebuild
```

This triggers a RESTYLE action - the entire document is regenerated with the new instructions while preserving the same source content.

### 4. Debug unexpected generation

```bash
# View the exact prompt context sent to Claude
bin/graft diff troubleshooting

# Review the packed prompt to see what sources and instructions were used
# Make corrections to the prompt file if needed
vim prompts/troubleshooting.md

# Regenerate
bin/graft rebuild
```

### 5. Check impact before editing

```bash
# See what will regenerate if you edit a source file
bin/graft uses src/entrypoint.sh

# Output shows all dependent stages
# Plan your changes knowing the documentation impact
```

### 6. Force regeneration

```bash
# Touch the prompt file to mark it as changed
touch prompts/configuration.md

# Rebuild to regenerate even if sources haven't changed
bin/graft rebuild
```

This triggers a RESTYLE action since the prompt file timestamp changed.

### 7. Validate configuration

```bash
# Check that all prompts are valid before running pipeline
bin/graft sync

# Review any errors in dependency declarations or configuration
# Fix issues, then run the full pipeline
bin/graft rebuild
```
