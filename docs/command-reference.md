<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=4371dedc6c64620d67017487e85f076bff8d1e60b28581d6c903a9ae26c92200 | rev=4b99e8d | 2025-11-04 -->
# Command Reference

All Graft commands run through the `bin/graft` wrapper script, which handles Docker execution, credential mounting, and environment setup. If no command is specified, `rebuild` runs by default.

For conceptual details about how Graft works, see [how-it-works.md](how-it-works.md). For credential configuration, see [configuration.md](configuration.md).

## Core Commands

### init

```bash
bin/graft init
```

Initialize Graft in a new project. This command:
- Creates `.env` file from `.env.example` if it doesn't exist
- Initializes DVC repository (`.dvc` directory)
- Prints instructions for installing git hooks

Run this once when setting up Graft in a new repository. After running, execute `bin/install-hooks` from the host to install the pre-commit hook.

**When to use:** First-time project setup, or after cloning a repository that uses Graft.

### rebuild

```bash
bin/graft rebuild
bin/graft          # Same as rebuild (default command)
```

Regenerate `dvc.yaml` from all `*.prompt.md` files and execute the full DVC pipeline. This is the primary command for documentation generation.

The command:
1. Scans for all `.prompt.md` files
2. Generates `dvc.yaml` with corresponding stages
3. Shows pipeline summary (number of stages to run)
4. Executes `dvc repro` with parallel execution (8 concurrent jobs by default)
5. Prints completion status

**When to use:** After modifying source files, prompt files, or dependencies. This is your main "generate documentation" command.

**Parallel execution:** By default, runs 8 stages concurrently. Configure with `DVC_JOBS` environment variable:

```bash
DVC_JOBS=4 bin/graft rebuild  # Run 4 concurrent jobs
DVC_JOBS=1 bin/graft rebuild  # Sequential execution
```

**Example output:**
```
üîß Generating dvc.yaml from prompt files...
üìã Pipeline has 3 stage(s) to run
üöÄ Running DVC pipeline with 8 concurrent jobs...
Running stage 'exec_summary'
üìù Rendering: exec-summary
‚úÖ Completed: exec-summary
‚úÖ Done.
```

### sync

```bash
bin/graft sync
bin/graft check    # Alias for sync
```

Regenerate `dvc.yaml` from `*.prompt.md` files without running the pipeline. Use this to validate that your prompt files are correctly structured and that the pipeline definition is up to date.

The command scans all prompts, extracts frontmatter (deps, model, output paths), and writes the updated `dvc.yaml`. No documents are generated.

**When to use:** 
- After creating or modifying `.prompt.md` files to update the pipeline definition
- To validate prompt file syntax before running the full pipeline
- When you want to see what stages would run (`bin/graft status`) without executing them

### status

```bash
bin/graft status
```

Show DVC pipeline status‚Äîwhich stages have changed dependencies and need to run. This is a wrapper around `dvc status` that shows you what `rebuild` would execute.

**Example output:**
```
exec_summary:
	changed deps:
		modified:           docs/strategy/foundations.md
recommendations:
	changed deps:
		modified:           docs/strategy/foundations.md
		modified:           docs/strategy/exec-summary.md
```

**When to use:** Before running `rebuild` to understand the scope of changes, or to verify that dependency tracking is working correctly.

## Document Management

### new

```bash
bin/graft new <name> [topic]
```

Create a new prompt file with a standard template structure.

**Parameters:**
- `name` (required) - Document name (e.g., 'exec-summary', 'api-guide')
- `topic` (optional) - Topic directory under `docs/` (default: 'strategy')

The command:
1. Creates `docs/<topic>/<name>.prompt.md` with frontmatter template
2. Regenerates `dvc.yaml` to include the new stage
3. Reports the created file path

**Generated template structure:**
```yaml
---
# Optional: override the model (default: bedrock-claude-v4.5-sonnet-us)
# model: bedrock-claude-v4.5-sonnet-us
deps:
  - docs/strategy/foundations.md
---
# <Name> ‚Äî Prompt
Write clear, concise strategic content. Edit only where source diffs imply semantic change.
```

**Examples:**

Create a new strategy document:
```bash
bin/graft new exec-summary strategy
# Creates: docs/strategy/exec-summary.prompt.md
```

Create an operations document:
```bash
bin/graft new runbook operations
# Creates: docs/operations/runbook.prompt.md
```

Create a technical document in default topic:
```bash
bin/graft new architecture
# Creates: docs/strategy/architecture.prompt.md
```

**Next steps after creation:**
1. Edit the generated `.prompt.md` file
2. Update the `deps:` list with actual dependencies
3. Write your prompt instructions
4. Run `bin/graft rebuild` to generate the document

## Inspection & Debugging

### diff

```bash
bin/graft diff <stage-name>
```

Inspect the complete packed prompt context that will be sent to the LLM for a specific stage. This shows you exactly what Claude sees, including the change analysis, diffs, previous draft, and all source content.

**Parameters:**
- `stage-name` (required) - Stage name (document basename with underscores, e.g., 'exec_summary')

The command:
1. Locates the prompt file for the specified stage
2. Runs `pack_prompt.py` to generate the full context
3. Writes to `build/<stage-name>.promptpack.txt`
4. Prints the output file path

**Example:**
```bash
bin/graft diff exec_summary
# Outputs: build/exec_summary.promptpack.txt
```

**When to use:**
- Debugging why a document isn't updating as expected
- Understanding what context the LLM receives
- Verifying that dependencies are included correctly
- Checking which action directive (GENERATE, UPDATE, REFINE, REFRESH, MAINTAIN) is being used
- Reviewing the exact diffs being presented to Claude

**Output contains:**
- System message with action definitions
- Change analysis (what changed: sources, prompt, or both)
- Previous draft (existing output)
- Source diff (if sources changed)
- Prompt diff (if instructions changed)
- Current prompt instructions
- Full content of all dependency files

### uses

```bash
bin/graft uses <file>
```

Show which prompt files depend on a given file (reverse dependency lookup). This reveals what will regenerate if you modify the specified file.

**Parameters:**
- `file` (required) - Path to a source file (e.g., 'docs/strategy/foundations.md')

**Example:**
```bash
bin/graft uses docs/strategy/foundations.md
# Output:
# docs/strategy/foundations.md is used by:
#   - docs/strategy/exec-summary.prompt.md
#   - docs/strategy/recommendations.prompt.md
#   - docs/operations/roadmap.prompt.md
```

**When to use:**
- Before editing a file to understand the impact scope
- Diagnosing why a document isn't regenerating (file not in any deps)
- Understanding documentation structure and dependencies
- Planning changes to minimize regeneration

## Environment & Configuration

### Environment Variables

The `bin/graft` wrapper recognizes these environment variables:

- `GRAFT_DIR` - Path to Graft repository (default: `../graft` relative to current repo)
- `DVC_JOBS` - Number of concurrent pipeline stages (default: 8)
- `AWS_PROFILE` - AWS credential profile to use
- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN` - Direct AWS credentials
- Variables in `.env` file are automatically loaded

### AWS Credentials

Graft supports multiple AWS credential methods:

1. **AWS directory mount** - `~/.aws` is mounted read-only into the container, supporting profiles and SSO
2. **Environment variables** - Credentials from host environment are passed through
3. **`.env` file** - Project-specific credentials loaded from `.env`

Priority order: environment variables > `.env` file > AWS directory.

For detailed credential configuration, see [configuration.md](configuration.md).

### Docker Image

Commands require the `graft:local` Docker image. If missing, you'll see:

```
Error: graft:local image not found
Build it first: cd /path/to/graft && make build
```

Build the image from the Graft repository:
```bash
cd /path/to/graft
make build
```

## Exit Codes

Graft commands use standard exit codes:

- **0** - Success
- **1** - Error during execution
  - Missing dependencies in prompt frontmatter
  - AWS authentication failure
  - DVC pipeline failure
  - Invalid prompt file syntax
- **2** - Invalid command or usage
  - Docker image not found
  - Unknown command
  - Missing required parameters

## Common Workflows

### Add a New Document

Create and generate a new strategic document:

```bash
# 1. Scaffold the prompt file
bin/graft new quarterly-review strategy

# 2. Edit the generated file
vim docs/strategy/quarterly-review.prompt.md
# - Update deps: to list source files
# - Write prompt instructions

# 3. Generate the document
bin/graft rebuild
```

### Update Dependencies

Modify which files a document depends on:

```bash
# 1. Edit prompt frontmatter
vim docs/strategy/exec-summary.prompt.md
# Add to deps:
#   - docs/research/market-analysis.md

# 2. Regenerate dvc.yaml
bin/graft sync

# 3. Run pipeline (will regenerate exec-summary with new dependency)
bin/graft rebuild
```

### Change Prompt Instructions

Modify how a document is generated:

```bash
# 1. Edit prompt body (after frontmatter)
vim docs/strategy/exec-summary.prompt.md
# Change instructions to emphasize different aspects

# 2. Regenerate (triggers REFINE action - full regeneration with new instructions)
bin/graft rebuild
```

The REFINE action regenerates the entire document according to the updated instructions while preserving the general structure where appropriate.

### Debug Generation Issues

Inspect what context the LLM receives for a document:

```bash
# 1. Generate the packed prompt
bin/graft diff exec_summary

# 2. Review the output
cat build/exec_summary.promptpack.txt
# Check:
# - Is the action directive correct? (GENERATE/UPDATE/REFINE/REFRESH/MAINTAIN)
# - Are all dependencies included?
# - Do the diffs show the expected changes?
# - Is the previous draft present?

# 3. If dependencies are missing, edit the prompt
vim docs/strategy/exec-summary.prompt.md

# 4. Regenerate
bin/graft sync
bin/graft rebuild
```

### Check Impact Before Editing

Understand what will regenerate before modifying a source file:

```bash
# 1. Check which prompts depend on the file
bin/graft uses docs/strategy/foundations.md
# Output: foundations.md is used by:
#   - docs/strategy/exec-summary.prompt.md
#   - docs/strategy/recommendations.prompt.md

# 2. Decide if the scope is acceptable
# If too broad, consider:
# - Splitting the source file
# - Reducing dependencies

# 3. Make your edit
vim docs/strategy/foundations.md

# 4. Verify what will run
bin/graft status

# 5. Regenerate affected documents
bin/graft rebuild
```

### Force Regeneration

Force a document to regenerate even when dependencies haven't changed:

```bash
# 1. Remove the output file
rm docs/strategy/exec-summary.md

# 2. Regenerate (triggers GENERATE action - full document creation)
bin/graft rebuild
```

Alternatively, touch the prompt file to trigger change detection:

```bash
# 1. Touch the prompt (updates modification time)
touch docs/strategy/exec-summary.prompt.md

# 2. Regenerate (triggers REFINE action)
bin/graft rebuild
```

### Validate Configuration

Check that prompt files are correctly configured before running the pipeline:

```bash
# 1. Regenerate dvc.yaml
bin/graft sync
# If this succeeds, all prompt files have valid syntax

# 2. Check pipeline status
bin/graft status
# Shows what would run without executing

# 3. If everything looks correct, run the pipeline
bin/graft rebuild
```
