<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=a5a440c4e3cb25a38b5fdd98af864f1daaefdb7d581dee48260ee113f8adba09 | rev=39b5c7a | 2025-11-04 -->
# Configuration

Graft is configured through environment variables, prompt frontmatter, and optional DVC settings. This guide covers all configuration options to help you set up and customize Graft for your needs.

## Environment Variables

Graft uses environment variables for AWS credentials, region configuration, and runtime settings. Create a `.env` file in your project root based on `.env.example`:

```bash
# AWS Region (required)
AWS_REGION=us-east-1
AWS_DEFAULT_REGION=us-east-1

# Optional: Explicit AWS credentials (see Authentication Methods below)
# AWS_ACCESS_KEY_ID=
# AWS_SECRET_ACCESS_KEY=
# AWS_SESSION_TOKEN=

# Optional: AWS profile selection
# AWS_PROFILE=your-profile-name

# Optional: Graft directory location (for dependent repos)
# GRAFT_DIR=/path/to/graft
```

### Environment Variable Reference

| Variable | Description | Default |
|----------|-------------|---------|
| `AWS_REGION` | AWS region for Bedrock API calls | `us-east-1` |
| `AWS_DEFAULT_REGION` | Fallback region setting | `us-east-1` |
| `LLM_MODEL` | Default model for all documents | `bedrock-claude-v4.5-sonnet-us` |
| `GRAFT_DIR` | Path to Graft installation (for wrapper scripts) | `../graft` (sibling directory) |
| `AWS_ACCESS_KEY_ID` | AWS access key (alternative auth method) | - |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key (alternative auth method) | - |
| `AWS_SESSION_TOKEN` | AWS session token (alternative auth method) | - |
| `AWS_PROFILE` | AWS CLI profile name (alternative auth method) | - |

## AWS Authentication Methods

Graft supports multiple AWS authentication methods to accommodate different environments and workflows.

### Recommended: AWS Directory Mount (Default)

The preferred method mounts your local `~/.aws` directory into the Docker container:

```bash
# On your host machine, configure AWS credentials
aws configure
# or for SSO:
aws sso login

# Then run Graft normally
./bin/graft rebuild
```

**Why this is recommended:**
- Works seamlessly with AWS SSO
- Supports multiple profiles
- No credential duplication
- Credentials stay on your host machine
- Automatic session refresh with SSO

The `bin/graft` wrapper automatically mounts `~/.aws` as read-only when the directory exists.

### Alternative: Environment Variables

For CI/CD environments or when you need explicit credential control:

```bash
# In your .env file:
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_SESSION_TOKEN=FwoGZXIvYXdzEBaa...  # If using temporary credentials
AWS_REGION=us-east-1
```

The `bin/graft` wrapper automatically passes through these variables to the container.

### Alternative: Container Environment

Set credentials directly when running Docker:

```bash
docker run --rm \
  -v "$(pwd):/work" \
  -e AWS_ACCESS_KEY_ID=your-key \
  -e AWS_SECRET_ACCESS_KEY=your-secret \
  -e AWS_REGION=us-east-1 \
  graft:local rebuild
```

### Troubleshooting Authentication

**ExpiredToken errors:**
```bash
# Refresh your AWS SSO session
aws sso login

# Or update your session token in .env if using explicit credentials
```

**"authentication" or "credentials" errors:**
- Verify your `.env` file exists and contains valid credentials
- Check that `~/.aws/credentials` is properly configured
- Ensure your AWS profile has Bedrock access permissions
- Confirm your region supports the Bedrock models you're using

**No credentials found:**
- Check that the `bin/graft` wrapper can find your `~/.aws` directory
- Verify Docker has permission to mount the directory
- Try setting credentials explicitly in `.env` as a fallback

## Prompt Frontmatter Schema

Each `.prompt.md` file can include YAML frontmatter to configure generation behavior:

```yaml
---
model: bedrock-claude-v4.5-sonnet-us
deps:
  - data/source.json
  - docs/other-doc.md
---

# Your prompt content here
```

### Frontmatter Parameters

#### `model` (optional)

Specifies which LLM model to use for this document. Overrides the `LLM_MODEL` environment variable.

```yaml
---
model: bedrock-claude-v4.5-sonnet-us
---
```

See the [Model Configuration](#model-configuration) section for available models.

#### `deps` (optional)

Lists source files that this document depends on. Graft includes the content of these files in the prompt and tracks them for change detection.

**Manual source files:**
```yaml
---
deps:
  - data/config.json
  - src/schema.py
---
```

**Generated docs as inputs (creates a DAG):**
```yaml
---
deps:
  - docs/api-reference.md
  - docs/data-model.md
---
```

This creates a dependency chain: when `api-reference.md` changes, both it and any docs depending on it will regenerate.

**Files outside docs/ directory:**
```yaml
---
deps:
  - ../sibling-repo/README.md
  - /absolute/path/to/source.txt
---
```

**Behavior and Rules:**

- Dependency paths are relative to the `.prompt.md` file location
- Absolute paths are supported
- Generated docs (`.md` files) create build order dependencies
- Source files (non-`.md`) are tracked for changes but don't affect build order
- Files are included in the prompt in the order listed
- Maximum recommended dependencies: ~10-15 files to stay within token limits
- Missing dependency files cause build errors (by design)

## Model Configuration

Graft uses AWS Bedrock models accessed via the `llm` CLI tool. The default model provides excellent performance for most documentation tasks.

### Default Model

```bash
bedrock-claude-v4.5-sonnet-us
```

This is Claude Sonnet 4.5 via the US cross-region inference profile. It offers:
- High-quality documentation generation
- Fast response times
- Good balance of capability and cost
- Automatic failover across US regions

### Available Models

Graft supports any Bedrock model accessible via `llm-bedrock` plugins. Common options:

| Model ID | Description | Use When |
|----------|-------------|----------|
| `bedrock-claude-v4.5-sonnet-us` | Claude Sonnet 4.5 (US profile) | Default, best for most docs |
| `bedrock-claude-v4.5-opus-us` | Claude Opus 4.5 (US profile) | Need maximum quality |
| `bedrock-claude-v4.5-haiku-us` | Claude Haiku 4.5 (US profile) | Need speed/lower cost |
| `bedrock-claude-3-5-sonnet-20241022-v2:0` | Direct model access | Need specific version |

**US Inference Profiles:**

Models ending in `-us` use AWS cross-region inference profiles:
- Automatic routing to available regions
- Higher availability and throughput
- Simplified region management
- Recommended for production use

To use a specific region instead:
```yaml
---
model: bedrock-claude-3-5-sonnet-20241022-v2:0
---
```

Then ensure your `AWS_REGION` matches a region where the model is available.

### Model Parameters

**Note:** Graft does not currently expose `temperature`, `top_p`, or `max_tokens` parameters. The models use their default settings.

**Workarounds for custom parameters:**

1. **Control output length via prompt instructions:**
   ```markdown
   Provide a concise summary in 2-3 paragraphs.
   ```

2. **Control creativity via prompt framing:**
   ```markdown
   Stick closely to the source material. Do not add speculative content.
   ```

3. **For advanced control:** Fork Graft and modify `scripts/render_llm.sh` to pass additional flags to the `llm` command.

## DVC Configuration

Graft uses DVC (Data Version Control) to track source files and manage the documentation build pipeline. The configuration lives in `.dvc/config`.

### Default Configuration

```ini
[cache]
    dir = .dvc/cache
    type = symlink

[core]
    autostage = true
```

**What this does:**

- `cache.dir`: Stores cached source files locally in `.dvc/cache/`
- `cache.type`: Uses symlinks for efficient storage (hardlinks on Windows)
- `core.autostage`: Automatically stages DVC files when sources change

### Local Cache Approach

Graft uses a **local cache** model:
- No remote storage required
- Source files are tracked by hash
- Cache is stored in `.dvc/cache/` (gitignored)
- Each developer has their own local cache
- Fast, simple, no additional infrastructure needed

This differs from DVC's typical use case of versioning large datasets with remote storage.

### When to Modify DVC Configuration

**You rarely need to change DVC settings.** The defaults work well for documentation pipelines.

**Possible customizations:**

```ini
# Use hardlinks instead of symlinks (Windows compatibility)
[cache]
    type = hardlink

# Store cache in a custom location
[cache]
    dir = /mnt/fast-disk/dvc-cache
```

For more DVC options, see: https://dvc.org/doc/user-guide/project-structure/configuration

## Docker Configuration

The Graft Docker image includes all tools needed to run the documentation pipeline.

### Dockerfile Contents

```dockerfile
FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git curl ca-certificates jq \
 && rm -rf /var/lib/apt/lists/*

# Install Python tools
RUN pip install --no-cache-dir dvc llm llm-bedrock llm-bedrock-anthropic pyyaml

# Copy and configure entrypoint
COPY scripts/entrypoint.sh /usr/local/bin/graft-entrypoint
RUN chmod +x /usr/local/bin/graft-entrypoint

# Set defaults
ENV AWS_REGION=us-east-1
WORKDIR /work
ENTRYPOINT ["/usr/local/bin/graft-entrypoint"]
CMD ["rebuild"]
```

**Included tools:**
- Python 3.12
- DVC for pipeline management
- `llm` CLI with Bedrock plugins
- Git for version control
- `jq` for JSON processing
- `curl` and `ca-certificates` for API calls

### Customizing the Docker Image

To add tools or change configuration:

1. **Edit the Dockerfile:**
   ```dockerfile
   # Add your customizations
   RUN apt-get install -y your-package
   RUN pip install your-python-package
   ```

2. **Rebuild the image:**
   ```bash
   make build
   # or:
   docker build -t graft:local .
   ```

3. **Use your custom image:**
   ```bash
   ./bin/graft rebuild
   ```

The `bin/graft` wrapper always uses the `graft:local` tag, so your changes apply automatically.

### Rebuild Process

When you modify the Dockerfile or any scripts:

```bash
# Full rebuild
make build

# Quick rebuild (uses cache)
docker build -t graft:local .

# No-cache rebuild
docker build --no-cache -t graft:local .
```

## Git Hooks

Graft includes a pre-commit hook that automatically regenerates `dvc.yaml` when prompt files change.

### Pre-Commit Hook

Install the hook:

```bash
./bin/graft install-hooks
```

This creates `.git/hooks/pre-commit` that:
1. Detects changes to `.prompt.md` files
2. Runs `make dvc.yaml` to regenerate the pipeline
3. Stages the updated `dvc.yaml` file
4. Allows the commit to proceed

### Why Synchronization Matters

The `dvc.yaml` file defines the build pipeline based on your `.prompt.md` files. When you:
- Add a new `.prompt.md` file
- Change frontmatter `deps`
- Rename or move prompt files

...the `dvc.yaml` must be updated to match. The pre-commit hook ensures these stay synchronized automatically.

**Without the hook:**
- Forgetting to regenerate `dvc.yaml` causes build errors
- CI/CD fails due to outdated pipeline definitions
- Other developers get inconsistent builds

**With the hook:**
- Pipeline stays synchronized automatically
- No manual `make dvc.yaml` commands needed
- Commits always include pipeline updates

### Manual Regeneration

If you skip the hook or need to regenerate manually:

```bash
make dvc.yaml
# or:
./bin/graft regenerate
```

---

## See Also

- [Getting Started](getting-started.md) - Initial setup and first build
- [Writing Prompts](writing-prompts.md) - How to write effective `.prompt.md` files
- [Development Workflow](development-workflow.md) - Day-to-day usage patterns

