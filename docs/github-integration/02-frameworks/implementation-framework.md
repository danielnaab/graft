<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=e5e6f426c49bfc56bd30b2fc4e9b234c18836cda38610deb738db44a599f87f8 | rev=4155622 | 2025-11-04 -->
# GitHub + Graft Integration: Implementation Framework

This document provides a comprehensive, implementation-ready framework for integrating Graft with GitHub Actions and Claude Code. It synthesizes the design philosophy and explorations into a phased roadmap with specific technical specifications.

## 1. Implementation Roadmap

### Phase 1: Foundation (MVP)

**Goal**: Prevent stale documentation from being merged

**Timeline**: 2-3 weeks

**What to Build**:

1. **Basic Validation Workflow** (`graft-validate.yml`)
   - Runs on all PRs and pushes
   - Checks for stale documentation
   - Blocks merge if validation fails
   - Reports clear errors

2. **Essential Slash Commands**
   - `/graft-validate` - Check documentation status
   - `/graft-regen` - Regenerate stale docs
   - `/graft-preview` - Show what will change

3. **Core Validation Logic**
   - DVC synchronization check
   - Dependency existence validation
   - Circular dependency detection
   - Staleness detection via git diff

4. **Docker Integration**
   - Pre-built image on GHCR
   - Proper workspace mounting
   - Environment variable passing

5. **AWS Authentication**
   - GitHub Secrets configuration (fallback)
   - OIDC setup documentation
   - Clear setup instructions

**Why This Phase First**:
- Solves the core problem: preventing stale docs
- Provides immediate value
- Establishes foundation for future features
- Validates architectural decisions

**Dependencies**: None (greenfield)

**Acceptance Criteria**:
- ✅ PR with stale docs fails CI check
- ✅ `/graft-validate` shows actionable errors
- ✅ `/graft-regen` successfully updates docs
- ✅ Documentation explains setup process
- ✅ Setup time < 30 minutes for new contributor
- ✅ False positive rate < 5%

### Phase 2: Enhanced Workflows

**Goal**: Improve developer experience and iteration speed

**Timeline**: 2-3 weeks

**What to Build**:

1. **Preview Generation Workflow** (`graft-preview.yml`)
   - Optional workflow triggered by label
   - Generates previews without committing
   - Posts comment with diff preview
   - Cost estimation before regeneration

2. **Enhanced Slash Commands**
   - `/graft-impact <file>` - Show dependency impact
   - `/graft-new-doc` - Scaffold new documentation
   - Improved error messages with suggestions

3. **Steward Skill Integration**
   - Conversational validation workflow
   - Context-aware suggestions
   - Automatic fix proposals
   - PR comment integration

4. **Auto-Commit Capability**
   - Bot commits regenerated docs to PR branch
   - Handles race conditions
   - Clear attribution
   - Conflict resolution strategy

5. **Performance Optimizations**
   - Docker layer caching
   - Parallel validation checks
   - Smart change detection (only check affected files)
   - Progress reporting for long operations

**Why This Phase Second**:
- Builds on proven foundation
- Addresses friction points discovered in Phase 1
- Enables faster iteration cycles
- Improves adoption through better UX

**Dependencies**:
- Phase 1 must be complete and stable
- 2+ weeks of usage data from Phase 1
- Feedback from early adopters

**Acceptance Criteria**:
- ✅ Preview generation < 5 minutes
- ✅ Auto-commit success rate > 95%
- ✅ Steward skill responds appropriately to doc questions
- ✅ Developer iteration time reduced by 50%
- ✅ Cost per preview < $0.50

### Phase 3: Advanced Features

**Goal**: Support power users and complex workflows

**Timeline**: 3-4 weeks

**What to Build**:

1. **Advanced Validation Modes**
   - Content verification (regenerate and compare)
   - Signature verification
   - Transitive dependency checking
   - Quality gates (length, completeness, style)

2. **Sophisticated Caching**
   - DVC remote cache on S3
   - Cross-branch cache reuse
   - Cache invalidation strategy
   - Cost-benefit optimization

3. **Workflow Automation**
   - Scheduled regeneration checks
   - Auto-fix minor issues
   - Dependency upgrade detection
   - Documentation coverage reports

4. **Monitoring and Analytics**
   - Cost tracking per PR/file
   - Performance metrics dashboard
   - Error rate monitoring
   - Usage analytics

5. **Advanced Claude Code Integration**
   - Multi-step workflow orchestration
   - Intelligent prompt refinement suggestions
   - Batch operations
   - Workflow templates

**Why This Phase Last**:
- Requires mature foundation
- Addresses edge cases and scale challenges
- Provides diminishing returns (80/20 rule)
- Can be developed incrementally

**Dependencies**:
- Phase 2 complete
- Minimum 1 month production usage
- Performance baseline established
- Cost model validated

**Acceptance Criteria**:
- ✅ Content verification catches 100% of manual edits
- ✅ Cache hit rate > 40%
- ✅ Monitoring dashboard shows all key metrics
- ✅ Advanced commands used by 30%+ of developers
- ✅ Zero false negatives in validation

## 2. Technical Specifications

### 2.1 GitHub Actions Workflows

#### Workflow 1: Validation (Phase 1)

**File**: `.github/workflows/graft-validate.yml`

```yaml
name: Validate Graft Documentation

# Trigger on all PRs and pushes to catch issues early
on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Only run when doc-related files change
    paths:
      - '**.prompt.md'
      - 'dvc.yaml'
      - 'dvc.lock'
      - 'docs/**'
      - 'sources/**'
  push:
    branches: [main]
    paths:
      - '**.prompt.md'
      - 'dvc.yaml'
      - 'docs/**'

# Prevent concurrent runs on same PR
concurrency:
  group: graft-validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Fast fail if stuck
    
    steps:
      # Need full history for git-based change detection
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history required
          
      # Cache Docker image to avoid repeated pulls (saves ~30s)
      - name: Cache Docker image
        uses: actions/cache@v3
        with:
          path: /tmp/graft-image.tar
          key: graft-docker-${{ runner.os }}-${{ hashFiles('.github/workflows/graft-validate.yml') }}
          restore-keys: |
            graft-docker-${{ runner.os }}-
            
      # Load or pull Graft image
      - name: Setup Graft Docker image
        run: |
          if [ -f /tmp/graft-image.tar ]; then
            echo "Loading cached image..."
            docker load < /tmp/graft-image.tar
          else
            echo "Pulling fresh image..."
            docker pull ghcr.io/${{ github.repository_owner }}/graft:latest
            docker save ghcr.io/${{ github.repository_owner }}/graft:latest > /tmp/graft-image.tar
          fi
          
      # Layer 1: Structural validation (no LLM calls)
      - name: Structural validation
        id: structural
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            ghcr.io/${{ github.repository_owner }}/graft:latest \
            python -m graft.validate.structural
        continue-on-error: true  # Continue to collect all errors
        
      # Layer 2: Change detection and staleness check
      - name: Detect stale documentation
        id: staleness
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            ghcr.io/${{ github.repository_owner }}/graft:latest \
            python -m graft.validate.staleness --json > staleness-report.json
        continue-on-error: true
        
      # Parse results and provide actionable feedback
      - name: Generate validation report
        if: always()
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            ghcr.io/${{ github.repository_owner }}/graft:latest \
            python -m graft.validate.report \
              --structural-exit-code ${{ steps.structural.outcome }} \
              --staleness-report staleness-report.json \
              --format github
              
      # Post comment on PR with results (if PR context)
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('validation-report.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('<!-- graft-validation-report -->')
            );
            
            const body = `<!-- graft-validation-report -->\n${report}`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
            
      # Fail if validation found issues
      - name: Check validation result
        if: steps.structural.outcome == 'failure' || steps.staleness.outcome == 'failure'
        run: |
          echo "::error::Documentation validation failed. See report for details."
          exit 1
```

#### Workflow 2: Preview Generation (Phase 2)

**File**: `.github/workflows/graft-preview.yml`

```yaml
name: Generate Documentation Preview

# Only run when explicitly requested (expensive operation)
on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to generate preview for'
        required: true
        type: number

jobs:
  preview:
    # Only run if 'graft:preview' label is present
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.label.name == 'graft:preview'
    
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Regeneration can be slow
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.event.inputs.pr_number }}
          
      # Setup AWS credentials for LLM access
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          
      # Load cached image
      - name: Cache Docker image
        uses: actions/cache@v3
        with:
          path: /tmp/graft-image.tar
          key: graft-docker-${{ runner.os }}-${{ hashFiles('.github/workflows/graft-validate.yml') }}
          
      - name: Load Graft image
        run: |
          if [ -f /tmp/graft-image.tar ]; then
            docker load < /tmp/graft-image.tar
          else
            docker pull ghcr.io/${{ github.repository_owner }}/graft:latest
          fi
          
      # Identify what would regenerate
      - name: Analyze changes
        id: analyze
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            ghcr.io/${{ github.repository_owner }}/graft:latest \
            python -m graft.validate.staleness --json > staleness.json
            
          # Extract list of stale files
          STALE_FILES=$(jq -r '.stale[] | .output' staleness.json | tr '\n' ' ')
          echo "files=${STALE_FILES}" >> $GITHUB_OUTPUT
          
          # Estimate cost (rough: $0.03 per file)
          FILE_COUNT=$(echo "$STALE_FILES" | wc -w)
          ESTIMATED_COST=$(echo "$FILE_COUNT * 0.03" | bc)
          echo "cost=${ESTIMATED_COST}" >> $GITHUB_OUTPUT
          echo "count=${FILE_COUNT}" >> $GITHUB_OUTPUT
          
      # Regenerate all stale docs
      - name: Generate previews
        id: generate
        if: steps.analyze.outputs.count > 0
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "$HOME/.aws:/root/.aws:ro" \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e AWS_SESSION_TOKEN \
            -e AWS_REGION \
            -w /workspace \
            ghcr.io/${{ github.repository_owner }}/graft:latest \
            python -m graft.rebuild ${{ steps.analyze.outputs.files }} \
              --json-output generation-report.json
              
      # Generate diff preview
      - name: Create diff preview
        if: steps.generate.outcome == 'success'
        run: |
          echo "# Documentation Preview" > preview.md
          echo "" >> preview.md
          echo "Generated previews for ${{ steps.analyze.outputs.count }} documents." >> preview.md
          echo "Estimated cost: \$${{ steps.analyze.outputs.cost }}" >> preview.md
          echo "" >> preview.md
          
          for file in ${{ steps.analyze.outputs.files }}; do
            echo "## ${file}" >> preview.md
            echo "" >> preview.md
            echo '```diff' >> preview.md
            git diff HEAD "${file}" >> preview.md
            echo '```' >> preview.md
            echo "" >> preview.md
          done
          
      # Post preview as comment
      - name: Post preview comment
        if: steps.generate.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const preview = fs.readFileSync('preview.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `<!-- graft-preview -->\n${preview}\n\n---\n*Preview generated by Graft. These changes are not committed.*`
            });
            
      # Remove label to prevent repeated runs
      - name: Remove preview label
        if: always() && github.event.label.name == 'graft:preview'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'graft:preview'
            });
```

#### Workflow 3: Auto-Regenerate (Phase 2)

**File**: `.github/workflows/graft-auto-regen.yml`

```yaml
name: Auto-Regenerate Documentation

on:
  pull_request:
    types: [labeled]

jobs
