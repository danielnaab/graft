<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=96fd0c625dfb16b4a23d37e1272d839b20c223d3ee63172e4a78049273d32a67 | rev=4155622 | 2025-11-04 -->
# Claude Code Integration Design

This document specifies the complete design for integrating Graft with Claude Code, enabling conversational documentation workflows within the editor.

## Architecture Overview

Claude Code integration operates at three levels:

1. **Slash Commands**: Direct invocations for specific operations (`/graft-validate`, `/graft-preview`, etc.)
2. **Steward Skill**: Conversational workflow assistance that activates contextually when discussing documentation
3. **GitHub Integration**: Automatic awareness of PR context, review comments, and commit workflows

The steward skill is the primary interface‚Äîusers describe what they're trying to accomplish, and Claude invokes commands as needed. Slash commands remain available for users who prefer explicit control.

## 1. Slash Command Specifications

### `/graft-validate`

**Purpose**: Validate documentation without regeneration‚Äîcheck that all prompts are well-formed, dependencies exist, and the configuration is valid.

**Syntax**:
```
/graft-validate [--fix]
```

**Implementation**:
```bash
# Run validation
docker run --rm \
  -v "$(pwd):/workspace" \
  -w /workspace \
  ghcr.io/dmarx/graft:latest \
  python -m graft check

# If --fix flag provided and fixable issues found
# Offer to fix automatically
```

**Output Format**:
```
‚úì Validating 12 prompt files...

ERRORS:
  docs/api-guide.md.prompt
    ‚Ä¢ Missing dependency: src/api/endpoints.py (not in git)
    ‚Ä¢ Invalid model reference: bedrock-claude-v4 (should be bedrock-claude-v4.5-sonnet-us)

WARNINGS:
  docs/deployment.md.prompt
    ‚Ä¢ No explicit dependencies (prompt may be underspecified)
    ‚Ä¢ Output file not in git (first generation)

Summary: 2 errors, 2 warnings in 2 files

Run with --fix to automatically correct fixable issues.
```

**User Interaction**:
```
You: /graft-validate

Claude: I'll validate your Graft documentation...

[runs validation]

Found 2 errors in your prompts:

1. **docs/api-guide.md.prompt** references src/api/endpoints.py, but that file isn't committed yet. You'll need to commit it first, or remove it from the prompt's dependencies.

2. **docs/api-guide.md.prompt** specifies model "bedrock-claude-v4" but the correct identifier is "bedrock-claude-v4.5-sonnet-us". Would you like me to fix this?

You: Yes, fix the model identifier

Claude: [updates the prompt file]

Fixed. The dependency issue remains‚Äîyou'll need to either:
- Commit src/api/endpoints.py 
- Remove it from the prompt if it's not actually needed

Which would you prefer?
```

**When to Use**:
- Before committing changes
- Before regenerating (fast pre-check)
- When troubleshooting generation failures
- As part of PR checks

**Error Handling**:
- Parse validation output for structured errors
- Categorize errors: fixable automatically, needs user decision, requires manual fix
- For fixable errors with `--fix`, show preview before applying
- For dependency errors, check if file exists but is uncommitted

---

### `/graft-preview`

**Purpose**: Show what will regenerate for current uncommitted changes, without actually regenerating.

**Syntax**:
```
/graft-preview [file...]
```

**Implementation**:
```bash
# Show status for all docs, or specific files if provided
docker run --rm \
  -v "$(pwd):/workspace" \
  -w /workspace \
  ghcr.io/dmarx/graft:latest \
  python -m graft status [files...]
```

**Output Format**:
```
üìã Preview: 4 documents will regenerate

GENERATE (new document):
  docs/new-feature.md
    Reason: No previous draft exists
    Sources: 
      + docs/new-feature.md.prompt (created)

UPDATE (sources changed):
  docs/api-guide.md
    Reason: Source files modified
    Sources:
      ~ src/api/endpoints.py (8 lines changed)
      ~ src/api/auth.py (2 lines changed)

REFINE (instructions changed):
  docs/deployment.md
    Reason: Prompt instructions updated
    Prompt diff:
      - Focus on Docker deployment
      + Focus on Docker and Kubernetes deployment

MAINTAIN (no changes):
  docs/installation.md
    Reason: No changes to sources or prompt
    
Estimated time: ~3 minutes
Estimated cost: ~$0.15
```

**User Interaction**:
```
You: /graft-preview

Claude: Let me check what would regenerate with your current changes...

[analyzes uncommitted changes]

4 documents will regenerate:

**docs/new-feature.md** - GENERATE
This is a new prompt file you created. Since there's no previous draft, it will generate from scratch.

**docs/api-guide.md** - UPDATE  
Your changes to src/api/endpoints.py and src/api/auth.py will trigger an update. The changes look like new endpoint definitions‚Äîthe doc will incorporate those semantically.

**docs/deployment.md** - REFINE
You updated the prompt to mention Kubernetes. Since the sources didn't change, this will refine the existing draft with the new instructions.

**docs/installation.md** - MAINTAIN
No changes needed‚Äîsources and prompt are unchanged.

This will take about 3 minutes and cost roughly $0.15. Ready to regenerate?
```

**When to Use**:
- Before running `/graft-regen` to understand impact
- When planning documentation changes
- To verify change detection is working as expected
- To check if unintended regeneration will occur

**Error Handling**:
- If no changes detected, explain: "No uncommitted changes found. All docs are up to date with git HEAD."
- If git is in detached HEAD state: warn that comparison may be unexpected
- If DVC cache is stale: warn and suggest `dvc pull`

---

### `/graft-regen`

**Purpose**: Regenerate all documentation that needs updating based on current changes.

**Syntax**:
```
/graft-regen [--force] [--dry-run] [file...]
```

**Flags**:
- `--force`: Regenerate even if validation fails (use with caution)
- `--dry-run`: Show what would happen without actually regenerating
- `file...`: Regenerate specific files only

**Implementation**:
```bash
# Validate first (unless --force)
if [ "$FORCE" != "true" ]; then
  graft check || exit 1
fi

# Show preview
graft status $FILES

# Confirm with user
read -p "Proceed with regeneration? [y/N] " confirm

# Regenerate
docker run --rm \
  -v "$(pwd):/workspace" \
  -v "$HOME/.aws:/root/.aws:ro" \
  -e AWS_PROFILE \
  -w /workspace \
  ghcr.io/dmarx/graft:latest \
  python -m graft rebuild $FILES
```

**Output Format**:
```
üîÑ Regenerating 4 documents...

[1/4] docs/new-feature.md (GENERATE)
  ‚è≥ Generating from scratch...
  ‚úì Generated (2.3s, $0.04)

[2/4] docs/api-guide.md (UPDATE)  
  ‚è≥ Applying source changes...
  ‚úì Updated (1.8s, $0.03)

[3/4] docs/deployment.md (REFINE)
  ‚è≥ Refining with new instructions...
  ‚úì Refined (1.5s, $0.02)

[4/4] docs/installation.md (MAINTAIN)
  ‚è≥ Verifying no changes needed...
  ‚úì Maintained (0.3s, $0.00)

‚úÖ Complete: 4 documents regenerated in 6.2s
üí∞ Total cost: $0.09

Changed files:
  M docs/new-feature.md
  M docs/api-guide.md
  M docs/deployment.md
```

**User Interaction**:
```
You: /graft-regen

Claude: Let me validate and preview what will regenerate...

[runs validation - passes]
[shows preview - 4 docs]

This looks good. Ready to regenerate these 4 documents? It'll take about 3 minutes and cost ~$0.15.

You: yes

Claude: Starting regeneration...

[shows progress in real-time]

Done! 4 documents regenerated successfully.

I notice the api-guide.md changes are substantial (120 lines changed). Would you like me to review the diff to make sure it looks right?

You: yes please

Claude: [shows key sections of the diff with commentary]

The changes look appropriate‚Äîthe new endpoints from src/api/endpoints.py are documented with proper examples. The authentication section was updated to match the new OAuth flow in src/api/auth.py.

One thing to check: the error handling section now references HTTP 429 rate limiting, but I don't see rate limit configuration in your sources. Is that intentional, or should we add rate limit details to the source material?
```

**When to Use**:
- After editing sources or prompts
- After validating and previewing changes
- As final step before committing
- During iterative documentation development

**Error Handling**:
- If validation fails: show errors and refuse to regenerate (unless `--force`)
- If AWS credentials missing: provide setup instructions
- If generation fails mid-process: show which docs succeeded, which failed, and why
- If user interrupts (Ctrl+C): clean up partial outputs, report progress
- If cost exceeds threshold (e.g., $1): warn and require explicit confirmation

**Progress Reporting**:
- Show each document as it starts
- Update with completion time and cost
- Show overall progress (X/Y complete)
- Provide ETA based on average time per doc
- Allow cancellation with partial commit option

---

### `/graft-impact <file>`

**Purpose**: Show which documentation prompts depend on a specific file, and what would regenerate if that file changed.

**Syntax**:
```
/graft-impact <file> [--tree]
```

**Flags**:
- `--tree`: Show dependency tree with transitive dependencies

**Implementation**:
```bash
# Find prompts that list this file as a dependency
docker run --rm \
  -v "$(pwd):/workspace" \
  -w /workspace \
  ghcr.io/dmarx/graft:latest \
  python -m graft uses "$FILE"
```

**Output Format**:
```
üìä Impact analysis: src/api/endpoints.py

DIRECT DEPENDENTS (3 prompts):
  docs/api-guide.md.prompt
    Purpose: Comprehensive API reference
    Last regenerated: 2 hours ago
    
  docs/quickstart.md.prompt
    Purpose: Getting started guide with API examples
    Last regenerated: 1 day ago
    
  docs/authentication.md.prompt
    Purpose: Authentication and authorization guide
    Last regenerated: 3 days ago

TRANSITIVE DEPENDENTS (1 prompt):
  docs/project-overview.md.prompt
    Via: docs/api-guide.md (referenced in overview)
    Purpose: Top-level project introduction
    Last regenerated: 1 day ago

Total impact: 4 documents will regenerate if this file changes

Use --tree to see the full dependency graph.
```

**User Interaction**:
```
You: /graft-impact src/api/endpoints.py

Claude: Let me check which docs depend on that file...

3 documents directly depend on src/api/endpoints.py:

1. **docs/api-guide.md** - This is the comprehensive API reference. It pulls endpoint definitions from this file to document all available routes.

2. **docs/quickstart.md** - The getting started guide includes example API calls using these endpoints.

3. **docs/authentication.md** - The auth guide references protected endpoints to explain authentication requirements.

Additionally, **docs/project-overview.md** will regenerate because it references the API guide.

So if you change src/api/endpoints.py, 4 documents will regenerate. Are you planning to edit it?

You: Yes, I'm adding a new endpoint

Claude: Got it. After you add the endpoint, the API guide will automatically document it, the quickstart will remain stable unless you change existing endpoints, and the auth guide will pick it up if it's a protected endpoint.

Want me to remind you to regenerate after you make the change?
```

**When to Use**:
- Before editing shared source files
- When planning refactors
- To understand documentation architecture
- To verify dependency declarations are correct

**Error Handling**:
- If file doesn't exist: check if it's a typo, suggest similar file names
- If file has no dependents: explain that it's not used by any prompts (might be untracked or unused)
- If file isn't committed: warn that it can't be a valid dependency until committed

---

### `/graft-new-doc`

**Purpose**: Interactively scaffold a new documentation prompt with proper structure and dependencies.

**Syntax**:
```
/graft-new-doc [name]
```

**Implementation**:
```bash
# Interactive prompt creation
# 1. Ask for document name (if not provided)
# 2. Ask for topic/purpose
# 3. Suggest dependencies based on topic
# 4. Generate prompt scaffold
# 5. Open in editor

docker run --rm \
  -v "$(pwd):/workspace" \
  -w /workspace \
  ghcr.io/dmarx/graft:latest \
  python -m graft new "$NAME" --interactive
```

**User Interaction**:
```
You: /graft-new-doc

Claude: I'll help you create a new documentation prompt. 

What would you like to document? (e.g., "API authentication", "deployment process", "testing guide")

You: Testing our microservices

Claude: Great. I'll create a testing guide. A few questions:

1. What aspects of testing should this cover?
   - Unit testing
   - Integration testing  
   - End-to-end testing
   - All of the above

You: All of the above, plus our CI setup

Claude: Perfect. For a comprehensive testing guide covering unit, integration, E2E, and CI, I'd suggest these dependencies:

**Code sources** (to show examples):
- tests/unit/test_example.py
- tests/integration/test_api.py
- tests/e2e/test_workflows.py

**Configuration** (to document setup):
- .github/workflows/test.yml
- pytest.ini
- docker-compose.test.yml

**Existing docs** (for context):
- docs/project-overview.md
- docs/development-setup.md

Does this look right, or would you like to add/remove dependencies?

You: Add docs/architecture.md too

Claude: Added. Now, what should I name this document? (suggestion: testing-guide.md)

You: testing-guide.md is fine

Claude: [creates docs/testing-guide.md.prompt with structure]

Created docs/testing-guide.md.prompt with:

```yaml
---
model: bedrock-claude-v4.5-sonnet-us
temperature: 1.0
max_tokens: 16000
cache_system_prompts: true
dependencies:
  - tests/unit/test_example.py
  - tests/integration/test_api.py
  - tests/e2e/test_workflows.py
  - .github/workflows/test.yml
  - pytest.ini
  - docker-compose.test.yml
  - docs/project-overview.md
  - docs/development-setup.md
  - docs/architecture.md
---

Create a comprehensive testing guide covering:

1. Testing philosophy and approach
2. Unit testing with pytest
3. Integration testing with test containers
4. End-to-end workflow testing
5. Running tests locally and in CI
6. Writing effective tests
7. Debugging test failures

Target audience: Developers contributing to the project
Tone: Practical and example-driven
```

I've scaffolded the prompt with sections for all the testing types you mentioned. Would you like me to:
1. Generate the initial draft now
2. Help you refine the prompt instructions first
3. Open the prompt file for you to edit manually

You: Generate the initial draft

Claude: [runs /graft-regen docs/testing-guide.md]

Done! I've generated the testing guide. It's about 800 lines covering all the areas you specified. Want to review it together to see if it needs refinement?
```

**When to Use**:
- Starting new documentation
- Adding docs for new features
- Filling gaps in documentation coverage
- When unsure
