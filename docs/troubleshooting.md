<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=15802fdbeb3b75c9bcbfe93e5205eee803d2b05c18bc6006d8122f8071e29388 | rev=39b5c7a | 2025-11-04 -->
# Troubleshooting Guide

This guide helps you diagnose and fix common issues when working with Graft. Each section starts with symptoms you might encounter, followed by diagnostic steps and solutions.

## Nothing Regenerated

**Symptom:** You run `bin/graft rebuild` but no documents are regenerated, or only some are updated.

### Why This Happens

DVC only regenerates documents when their dependencies change. If you edit a document that isn't listed in any `deps:` section, nothing downstream will regenerate.

### Diagnostic Commands

Check which stages need to run:

```bash
bin/graft status
```

If everything shows as up-to-date but you expected changes, check which prompts depend on the file you edited:

```bash
bin/graft uses docs/strategy/your-file.md
```

If this returns nothing, no prompts depend on that file.

### Solutions

**Add the file as a dependency** in the relevant `.prompt.md` front matter:

```yaml
---
deps:
  - docs/strategy/your-file.md
---
```

Then regenerate the pipeline:

```bash
bin/graft sync
bin/graft rebuild
```

**Force regeneration** of a specific stage:

```bash
dvc repro --force <stage-name>
```

For example, to force regenerate the exec-summary:

```bash
dvc repro --force exec_summary
```

**Force regeneration of everything**:

```bash
dvc repro --force
```

### Verify Success

After running `dvc repro`, you should see output like:

```
Running stage 'exec_summary'
üìù Rendering: exec_summary
ü§ñ Using model: bedrock-claude-v4.5-sonnet-us
‚úÖ Completed: exec_summary
```

## AWS Authentication Errors

**Symptom:** Errors mentioning `ExpiredToken`, `authentication`, `credentials`, or `UnauthorizedOperation` when running the pipeline.

### Common Error Messages

```
Error calling LLM (attempt 1/3):
botocore.exceptions.ClientError: An error occurred (ExpiredToken) when calling the InvokeModel operation
```

```
Error calling LLM (attempt 1/3):
Could not connect to the endpoint URL
```

The `render_llm.sh` script detects these errors and provides context-specific advice.

### Diagnostic Commands

**Check if AWS credentials are configured:**

```bash
docker run --rm \
  -v "$(pwd):/work" \
  -v ~/.aws:/root/.aws:ro \
  --env-file .env \
  graft:local \
  aws sts get-caller-identity
```

Expected output shows your AWS account and user:

```json
{
    "UserId": "AIDAXXXXXXXXXX",
    "Account": "123456789012",
    "Arn": "arn:aws:iam::123456789012:user/your-name"
}
```

**Test Bedrock access specifically:**

```bash
docker run --rm \
  -v "$(pwd):/work" \
  -v ~/.aws:/root/.aws:ro \
  --env-file .env \
  graft:local \
  aws bedrock list-foundation-models --region us-west-2
```

### Solutions

#### Expired Credentials (AWS SSO)

If using AWS SSO, refresh your credentials:

```bash
aws sso login --profile your-profile
```

Then verify credentials are working:

```bash
aws sts get-caller-identity --profile your-profile
```

Ensure your `.env` file has:

```
AWS_PROFILE=your-profile
```

Or set it when running:

```bash
AWS_PROFILE=your-profile bin/graft rebuild
```

#### Missing Credentials

Create or update `.env` from the example:

```bash
cp .env.example .env
```

Add your credentials (choose one method):

**Method 1: AWS Profile** (recommended)
```
AWS_PROFILE=your-profile
```

**Method 2: Direct credentials**
```
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AWS_SESSION_TOKEN=xxxx...  # if using temporary credentials
```

#### IAM Permissions

Your IAM user or role needs:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "bedrock:InvokeModel",
                "bedrock:InvokeModelWithResponseStream"
            ],
            "Resource": "arn:aws:bedrock:*::foundation-model/*"
        }
    ]
}
```

#### Model Availability by Region

Claude models may not be available in all regions. The default model `bedrock-claude-v4.5-sonnet-us` uses `us-west-2`.

To use a different region, configure your LLM keys:

```bash
llm keys set bedrock-claude-v4.5-sonnet-us
```

Enter `us-east-1` or another region where your model is available.

Or override in your prompt front matter:

```yaml
---
model: bedrock-claude-v4.5-sonnet-eu  # EU region
---
```

### Verify Success

After fixing credentials, test with a simple command:

```bash
bin/graft status
```

This should complete without authentication errors.

## Docker Image Not Found

**Symptom:** Error when running `bin/graft`:

```
Error: graft:local image not found
Build it first: cd /path/to/graft && make build
```

Or:

```
Error: Cannot find graft directory at /path/to/graft
Set GRAFT_DIR environment variable to point to graft repo
```

### Why This Happens

The `bin/graft` wrapper script looks for a Docker image named `graft:local` and the graft source code directory. If you've just cloned the repository or the graft directory is in a non-standard location, these checks fail.

### Solutions

#### Build the Docker Image

Navigate to the graft repository and build:

```bash
cd /path/to/graft
make build
```

Expected output:

```
docker build -t graft:local .
[+] Building 23.4s (12/12) FINISHED
...
Successfully tagged graft:local
```

#### Verify Image Exists

```bash
docker image inspect graft:local
```

Should return JSON with image details. If not found, rebuild.

#### Custom Graft Location

If graft is not in the default sibling directory, set `GRAFT_DIR`:

```bash
export GRAFT_DIR=/path/to/graft
bin/graft rebuild
```

Or permanently in your shell profile:

```bash
echo 'export GRAFT_DIR=/path/to/graft' >> ~/.bashrc
source ~/.bashrc
```

The `bin/graft` script checks this location:

```bash
GRAFT_DIR="${GRAFT_DIR:-$(dirname "$(dirname "$(realpath "$0")")")/../graft}"
```

### Verify Success

```bash
bin/graft help
```

Should display the help message without errors.

## Large Diffs in Generated Docs

**Symptom:** Generated documents show large diffs even though source changes were small. Sections that shouldn't change are being rewritten.

### Why This Happens

LLMs can rephrase content even when instructed to preserve it. The CHANGE ANALYSIS system tells the LLM what action to take (UPDATE, RESTYLE, etc.), but the prompt instructions must reinforce preservation behavior.

### Diagnostic Commands

**Inspect the packed prompt** to see exactly what the LLM receives:

```bash
bin/graft diff exec_summary
```

This creates `build/exec_summary.promptpack.txt` showing:
- CHANGE ANALYSIS directive
- Source diffs
- Previous draft content
- Style prompt instructions

Review this file to understand what the LLM sees.

### Solutions

#### Strengthen Preservation Instructions

Edit your `.prompt.md` to emphasize selective updates:

**Good example:**

```markdown
---
deps:
  - docs/strategy/foundations.md
---
# Strategic Overview Prompt

Write clear, strategic content following these rules:

**Preservation:** Only edit sections where source diffs explicitly indicate semantic changes. Keep all other sections word-for-word identical to the previous draft.

**Changes:** When updating, make surgical edits. Preserve structure, headings, and unchanged paragraphs exactly.

**Style:** Use clear, direct language. Prefer active voice. Break complex ideas into sections.
```

**Weak example (causes large diffs):**

```markdown
# Strategic Overview Prompt

Write a strategic overview covering the key points from the sources.
```

This gives no preservation guidance, so the LLM may rewrite everything.

#### Review Source Diffs

Check what's actually changing in your sources:

```bash
git diff docs/strategy/
```

If sources have large changes, large output changes are expected. If sources have small changes but output changes are large, your preservation instructions need strengthening.

#### Test with Explicit Previous Content

The CHANGE ANALYSIS includes the previous draft for UPDATE directives. Verify your prompt instructions reference this:

```markdown
When action is UPDATE: Apply only the semantic changes from source diffs. Copy unchanged sections verbatim from the previous draft.
```

### Verify Success

After adjusting instructions, regenerate and check the diff:

```bash
bin/graft rebuild
git diff docs/strategy/exec-summary.md
```

A good result: only sections related to source changes show diffs.

## Dependency Errors

**Symptom:** Errors about missing files, circular dependencies, or stages failing to run.

### Common Error Messages

```
ERROR: failed to reproduce 'exec_summary': file 'docs/strategy/missing.md' does not exist
```

```
ERROR: failed to load pipeline: Cycle detected
```

### Diagnostic Commands

**Check which files depend on what:**

```bash
bin/graft uses docs/strategy/foundations.md
```

Shows all prompts depending on this file.

**View the generated pipeline:**

```bash
cat dvc.yaml
```

Look for the stage causing issues and check its `deps:` and `outs:` sections.

**Validate dependency structure:**

```bash
bin/graft check
dvc dag
```

The `dvc dag` command shows the dependency graph. Circular references will cause errors.

### Solutions

#### Missing Dependency File

If a file doesn't exist, either:

**Create it:**

```bash
touch docs/strategy/missing.md
```

**Remove the dependency** from the `.prompt.md` front matter:

```yaml
---
deps:
  # - docs/strategy/missing.md  # Commented out
  - docs/strategy/foundations.md
---
```

Then regenerate:

```bash
bin/graft sync
```

#### Circular Dependencies

**Bad example:**

```
docs/strategy/a.prompt.md:
  deps:
    - docs/strategy/b.md

docs/strategy/b.prompt.md:
  deps:
    - docs/strategy/a.md
```

This creates: a.md ‚Üí b.md ‚Üí a.md (circular).

**Fix by removing the cycle:**

Structure dependencies as a directed acyclic graph (DAG):

```
foundations.md
    ‚Üì
messaging.md
    ‚Üì
exec-summary.md
```

Each prompt should depend only on documents earlier in the chain.

#### Good vs Bad Dependency Structures

**Good (tree structure):**

```yaml
# foundations.prompt.md
deps:
  - docs/external/source.md

# messaging.prompt.md  
deps:
  - docs/strategy/foundations.md

# exec-summary.prompt.md
deps:
  - docs/strategy/foundations.md
  - docs/strategy/messaging.md
```

**Bad (circular):**

```yaml
# messaging.prompt.md
deps:
  - docs/strategy/exec-summary.md  # ‚ùå

# exec-summary.prompt.md
deps:
  - docs/strategy/messaging.md  # ‚ùå
```

### Verify Success

```bash
dvc dag
```

Should display a clean directed graph with no cycles:

```
+-----------------+
| foundations.dvc |
+-----------------+
         *
         *
         *
   +-----------+
   | messaging |
   +-----------+
         *
         *
         *
  +---------------+
  | exec_summary  |
  +---------------+
```

## DVC Errors

**Symptom:** Errors during `dvc repro`, corrupted cache, or stage failures.

### Common Error Messages

```
ERROR: failed to reproduce 'exec_summary': unexpected error - ...
```

```
ERROR: corrupted cache file
```

```
ERROR: stage 'exec_summary' failed
```

### Diagnostic Commands

**View detailed logs** from the last run:

DVC captures stdout/stderr in the build directory:

```bash
cat build/exec_summary.err
```

Shows the actual error from the LLM call.

**Check DVC cache status:**

```bash
dvc cache dir
dvc status
```

### Solutions

#### Corrupted Cache

Remove and rebuild:

```bash
rm -rf .dvc/cache
dvc repro --force
```

This regenerates everything from scratch.

#### Stage Failures

Common causes:

**1. Credential expiration:** See [AWS Authentication Errors](#aws-authentication-errors)

**2. Rate limiting:** AWS Bedrock has quotas. Wait a few minutes and retry:

```bash
dvc repro
```

The `render_llm.sh` script automatically retries transient errors with exponential backoff (1s, 2s delays).

**3. Invalid syntax in prompt:** Check your `.prompt.md` file:

```bash
cat docs/strategy/exec-summary.prompt.md
```

Ensure YAML front matter is valid:

```yaml
---
deps:
  - docs/strategy/foundations.md  # No extra quotes or formatting
---
```

**4. Model not available:** Check that your model exists:

```bash
llm models list | grep bedrock
```

Should show your configured model. If not, reconfigure:

```bash
llm keys set bedrock-claude-v4.5-sonnet-us
```

#### View Stage Definition

Check how DVC is running the stage:

```bash
grep -A 10 "exec_summary:" dvc.yaml
```

Shows the command, deps, and outs. Verify they're correct.

### Verify Success

After fixing issues:

```bash
bin/graft rebuild
```

Should complete all stages:

```
‚úÖ Completed: foundations
‚úÖ Completed: messaging
‚úÖ Completed: exec_summary
```

## Performance Issues

**Symptom:** Pipeline takes a long time to run, or stages regenerate unnecessarily.

### Expected Performance

- Each LLM call: 10-60 seconds depending on model and prompt size
- DVC runs stages in parallel when possible
- First run is slower (no cache)
- Subsequent runs only regenerate changed stages

### Diagnostic Commands

**Time a full rebuild:**

```bash
time bin/graft rebuild
```

**Check which stages are running:**

```bash
bin/graft status
```

Shows only stages that need regeneration.

**Find unnecessary dependencies:**

```bash
bin/graft uses docs/strategy/foundations.md
```

If many prompts depend on a frequently-changing file, they'll all regenerate every time it changes.

### Solutions

#### Slow Generation

**Optimize prompt size:** Large prompts take longer to process.

Check packed prompt size:

```bash
bin/graft diff exec_summary
wc -l build/exec_summary.promptpack.txt
```

If over 10,000 lines, consider:
- Reducing source file size
- Splitting into multiple smaller documents
- Using more focused dependencies

**Reduce dependency count:** Only include sources you actually need:

```yaml
---
deps:
  # Only include what this document needs
  - docs/strategy/foundations.md
  # - docs/strategy/everything-else.md  # Remove unnecessary deps
---
```

#### Many Unnecessary Regenerations

**Symptom:** Editing one file triggers regeneration of many documents.

**Diagnose:**

```bash
bin/graft uses docs/strategy/foundations.md
```

If this shows 10+ dependents, consider restructuring.

**Solution:** Create intermediate documents:

Instead of:
```
foundations.md
    ‚Üì
    ‚îú‚îÄ‚Üí doc1.md
    ‚îú‚îÄ‚Üí doc2.md
    ‚îú‚îÄ‚Üí doc3.md
    ‚îú‚îÄ‚Üí doc4.md
    ‚îî‚îÄ‚Üí doc5.md
```

Use:
```
foundations.md
    ‚Üì
    ‚îú‚îÄ‚Üí theme-a.md
    ‚îÇ      ‚Üì
    ‚îÇ      ‚îú‚îÄ‚Üí doc1.md
    ‚îÇ      ‚îî‚îÄ‚Üí doc2.md
    ‚îî‚îÄ‚Üí
