<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=14af5f1e1a057c70fa64fb93782a45c0c529be2c50aa92296440ba69f54c8aa7 | rev=16b2c01 | 2025-11-04 -->
# Troubleshooting Guide

This guide helps you diagnose and fix common issues when working with Graft.

## Nothing Regenerated

**Symptom:** You run `bin/graft rebuild` but no documents are regenerated, even though you made changes.

### Why This Happens

DVC tracks dependencies declared in your `deps:` frontmatter. If the files you changed aren't listed as dependencies, or if the change doesn't affect the content (like whitespace or comments), DVC sees nothing to do.

### Diagnostic Steps

1. **Check pipeline status:**
   ```bash
   bin/graft status
   ```
   
   If you see no output or "Pipeline is up to date", DVC thinks everything is current.

2. **Verify dependencies for a document:**
   ```bash
   # Check which prompts depend on a file
   bin/graft uses docs/strategy/foundations.md
   ```
   
   This shows which documents will regenerate when that file changes.

3. **Inspect the packed prompt:**
   ```bash
   bin/graft diff exec_summary
   ```
   
   This shows exactly what context the LLM receives. If your changed file isn't in the output, it's not a declared dependency.

### Solutions

**Add missing dependencies:**

Edit the frontmatter in your `.prompt.md` file:

```yaml
---
deps:
  - docs/strategy/foundations.md
  - docs/strategy/messaging.md  # Add this line
---
```

Then regenerate:

```bash
bin/graft sync    # Update dvc.yaml
bin/graft rebuild # Run the pipeline
```

**Force regeneration of a specific document:**

```bash
# Remove the cached output
rm docs/strategy/exec-summary.md

# Regenerate
bin/graft rebuild
```

**Force regeneration of everything:**

```bash
# Clear all generated documents
find docs -name "*.md" ! -name "*.prompt.md" -type f -delete

# Rebuild
bin/graft rebuild
```

### Verify the Fix

After regenerating, you should see output like:

```
üîß Generating dvc.yaml from prompt files...
üìã Pipeline has 3 stage(s) to run
üöÄ Running DVC pipeline...
Running stage 'exec_summary'
üìù Rendering: exec-summary
ü§ñ Using model: bedrock-claude-v4.5-sonnet-us
‚úÖ Completed: exec-summary
```

## AWS Authentication Errors

**Symptom:** You see errors like:

```
Error calling LLM (attempt 1/3):
ExpiredToken: The security token included in the request is expired
```

or

```
An error occurred (UnrecognizedClientException) when calling the InvokeModel operation
```

### Diagnostic Steps

1. **Check if AWS credentials are configured:**
   ```bash
   docker run --rm \
     -v ~/.aws:/root/.aws:ro \
     -e AWS_PROFILE \
     graft:local \
     bash -c 'aws sts get-caller-identity'
   ```
   
   Expected output shows your AWS account and user:
   ```json
   {
       "UserId": "AIDAEXAMPLE",
       "Account": "123456789012",
       "Arn": "arn:aws:iam::123456789012:user/yourname"
   }
   ```

2. **Test Bedrock access directly:**
   ```bash
   aws bedrock list-foundation-models --region us-east-1
   ```
   
   If this fails, your credentials don't have Bedrock permissions.

3. **Check your .env file:**
   ```bash
   cat .env | grep AWS
   ```
   
   Should show your region and optionally credentials.

### Common Causes and Solutions

**Expired SSO Token:**

The render script detects this and tells you:

```
üí° AWS credentials expired. To fix:
   - Run: aws sso login
   - Or refresh your AWS_SESSION_TOKEN in .env
```

Solution:
```bash
aws sso login
# Then try again
bin/graft rebuild
```

**Missing IAM Permissions:**

Your AWS user/role needs these permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "bedrock:InvokeModel",
        "bedrock:InvokeModelWithResponseStream"
      ],
      "Resource": "arn:aws:bedrock:*::foundation-model/*"
    }
  ]
}
```

Contact your AWS administrator to add the `bedrock:InvokeModel` permission.

**Wrong Region:**

Bedrock models aren't available in all regions. Update your `.env`:

```bash
AWS_DEFAULT_REGION=us-east-1  # Claude models available here
```

Supported regions for Claude:
- `us-east-1` (N. Virginia)
- `us-west-2` (Oregon)
- `eu-west-3` (Paris)
- `eu-central-1` (Frankfurt)

**Environment Variables Not Passed:**

The `bin/graft` wrapper automatically passes AWS credentials from your host. If you're running Docker manually, ensure you include:

```bash
docker run --rm \
  -v ~/.aws:/root/.aws:ro \
  -e AWS_PROFILE \
  -e AWS_ACCESS_KEY_ID \
  -e AWS_SECRET_ACCESS_KEY \
  -e AWS_SESSION_TOKEN \
  --env-file .env \
  graft:local \
  rebuild
```

### Verify the Fix

After fixing credentials, you should see:

```
ü§ñ Using model: bedrock-claude-v4.5-sonnet-us
‚úÖ Completed: exec-summary
```

No authentication errors in the output.

## Docker Image Not Found

**Symptom:**

```
Error: graft:local image not found
Build it first: cd /path/to/graft && make build
```

### Why This Happens

The `bin/graft` wrapper script checks for the `graft:local` Docker image before running. This check prevents confusing errors later.

### Solution

**Build the image:**

```bash
cd /path/to/graft
make build
```

Expected output:

```
docker build -t graft:local .
[+] Building 23.4s (12/12) FINISHED
 => [internal] load build definition
 ...
 => => naming to docker.io/library/graft:local
```

**Verify the image exists:**

```bash
docker image ls graft:local
```

Expected output:

```
REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
graft        local     abc123def456   2 minutes ago    1.2GB
```

### Custom Graft Location

If Graft isn't in the default sibling directory, set `GRAFT_DIR`:

```bash
export GRAFT_DIR=/home/user/projects/graft
bin/graft rebuild
```

Or create a wrapper script in your project:

```bash
#!/bin/bash
export GRAFT_DIR=/home/user/projects/graft
exec "$(dirname "$0")/graft" "$@"
```

### Verify the Fix

After building, `bin/graft --help` should show the help message without errors.

## Large Diffs in Generated Docs

**Symptom:** When you make a small change to a source file, the generated document shows large, unexpected diffs. Content that should be preserved gets rewritten.

### Why This Happens

Graft uses `UPDATE` directives to show the LLM what changed, but the LLM might not understand that unchanged content should be preserved exactly. This usually means your prompt needs clearer preservation instructions.

### Diagnostic Steps

1. **Check what the LLM sees:**
   ```bash
   bin/graft diff exec_summary > /tmp/prompt.txt
   cat /tmp/prompt.txt
   ```
   
   Look at the `CHANGE ANALYSIS` section. Does it correctly identify the scope of changes?

2. **Review your prompt instructions:**
   ```bash
   cat docs/strategy/exec-summary.prompt.md
   ```
   
   Do you have explicit preservation instructions?

### Solutions

**Add preservation instructions to your prompt:**

‚ùå **Bad** (too vague):

```markdown
---
deps:
  - docs/strategy/foundations.md
---
# Executive Summary Prompt
Write a compelling executive summary based on the foundations.
```

‚úÖ **Good** (explicit preservation):

```markdown
---
deps:
  - docs/strategy/foundations.md
---
# Executive Summary Prompt

You are maintaining a strategic document. You will receive a CHANGE ANALYSIS 
that tells you exactly what changed.

Follow the action directive:
- UPDATE: Apply ONLY the semantic changes from SOURCE DIFF
- MAINTAIN: Output should be identical to previous draft
- GENERATE: Create from scratch

For UPDATE: Keep all unchanged sections byte-identical. Only modify content 
where the source diff implies a semantic change. Preserve formatting, style, 
and wording of unchanged sections exactly.

Write clear, compelling executive summary content focusing on strategic impact.
```

**Example of effective preservation pattern:**

Your prompt should include the same guidance from the main prompt system:

```markdown
For UPDATE: The diff shows you exactly what changed. Use semantic judgment 
to determine the scope of changes needed. A factual correction (e.g., date 
change) requires only a line change. A conceptual change (e.g., new strategy) 
may require section rewrites. Preserve unchanged content exactly.
```

**Test your changes:**

```bash
# Make a small change to a dependency
echo "# New Section" >> docs/strategy/foundations.md

# Regenerate
bin/graft rebuild

# Check the diff
git diff docs/strategy/exec-summary.md
```

The diff should be proportional to your change.

### Verify the Fix

After improving your prompt instructions:

1. Make a small, isolated change to a dependency
2. Regenerate the document
3. The git diff should show only relevant changes
4. Formatting, style, and unchanged sections remain identical

## Dependency Errors

**Symptom:**

```
ERROR: failed to reproduce 'exec_summary': Dependency 'docs/strategy/missing.md' 
does not exist
```

or

```
ERROR: Circular dependency detected: exec_summary -> foundations -> exec_summary
```

### Missing Dependencies

**Diagnostic:**

```bash
# Find the prompt file
cat docs/strategy/exec-summary.prompt.md
```

Look at the `deps:` list. Check if each file exists:

```bash
ls -l docs/strategy/missing.md
```

**Solution:**

Either create the missing file or remove it from dependencies:

```yaml
---
deps:
  - docs/strategy/foundations.md
  # - docs/strategy/missing.md  # Removed
---
```

Then:

```bash
bin/graft sync
bin/graft rebuild
```

### Circular Dependencies

**Example of problematic structure:**

```
exec-summary.prompt.md
  deps:
    - foundations.md

foundations.prompt.md
  deps:
    - exec-summary.md  # ‚ùå Creates cycle
```

**Solution - Restructure dependencies:**

‚úÖ **Good** (hierarchical):

```
foundations.prompt.md
  deps:
    - (none - base document)

exec-summary.prompt.md
  deps:
    - foundations.md

recommendations.prompt.md
  deps:
    - foundations.md
    - exec-summary.md
```

Documents should depend on static sources or earlier-generated documents, never in cycles.

**Alternative - Use static sources:**

Instead of depending on generated documents, depend on shared static sources:

```
docs/strategy/
  _inputs/
    research.md          # Static source
    data.md              # Static source
  foundations.prompt.md  # deps: _inputs/*
  exec-summary.prompt.md # deps: _inputs/*
```

### Verify the Fix

```bash
bin/graft status
```

Should show no errors and list what will run:

```
exec_summary:
	changed deps:
		modified:           docs/strategy/foundations.md
```

## DVC Errors

**Symptom:** Pipeline fails with DVC-specific errors.

### Corrupted Cache

```
ERROR: failed to reproduce 'exec_summary': unable to read stage cache
```

**Solution:**

```bash
# Clear DVC cache
rm -rf .dvc/cache
rm -rf build/

# Regenerate
bin/graft rebuild
```

### Stage Failures

```
ERROR: failed to reproduce 'exec_summary': Reproduction of stage 'exec_summary' 
failed
```

**Diagnostic - View the actual error:**

DVC captures command output. Check the error file:

```bash
cat build/exec-summary.err
```

Common causes:

1. **Credential expiration** - See [AWS Authentication Errors](#aws-authentication-errors)

2. **Rate limiting:**
   ```
   ThrottlingException: Rate exceeded
   ```
   
   Solution: Wait 60 seconds and retry. The render script automatically retries with exponential backoff.

3. **Invalid prompt syntax:**
   ```
   ERROR: failed to parse prompt frontmatter
   ```
   
   Solution: Check YAML syntax in your `.prompt.md` file:
   ```bash
   # YAML lint your prompt
   python3 -c "import yaml; yaml.safe_load(open('docs/strategy/exec-summary.prompt.md').read().split('---')[1])"
   ```

### Viewing Logs

DVC shows minimal output. To see detailed logs:

```bash
# Run with verbose output
dvc repro -v

# Or check build directory for temporary files
ls -la build/
cat build/exec-summary.tmp  # LLM output before processing
```

### Verify the Fix

After resolving:

```bash
bin/graft rebuild
```

Should complete without errors:

```
‚úÖ Done.
```

## Performance Issues

### Slow Generation

**Symptom:** Documents take a long time to generate (>30 seconds per document).

**Expected timing:**
- Simple document (1-2 deps): 5-15 seconds
- Complex document (5+ deps): 15-30 seconds
- Very large context: 30-60 seconds

**Causes:**

1. **Large dependencies** - Including entire large documents inflates context
2. **Too many dependencies** - Each dependency adds to the prompt
3. **Network latency** - Bedrock API calls have inherent latency

**Solutions:**

**Optimize dependencies:**

Instead of depending on complete large documents, extract relevant sections to smaller files:

‚ùå **Bad:**
```yaml
deps:
  - docs/complete-research.md  # 10,000+ lines
```

‚úÖ **Good:**
```yaml
deps:
  - docs/research-summary.md   # 200 lines, extracted key points
```

**Break up large documents:**

Instead of one massive generated document, create a hierarchy:

```
foundations.md (base)
  ‚Üì
section-1.md, section-2.md (focused documents)
  ‚Üì
complete-report.md (assembles sections)
```

**Use selective dependencies:**

Only include dependencies that directly influence the content:

```yaml
deps:
  - docs/strategy/messaging.md      # ‚úÖ Directly referenced
  # - docs/legal/disclaimers.md    # ‚ùå Not actually used
```

### Parallel Execution

DVC automatically parallelizes independent stages. Check if your pipeline structure allows parallelization:

```bash
# View the dependency graph
dvc dag
```

Documents with non-overlapping dependencies run in parallel.

### Many Unnecessary Regenerations

**Symptom:** Every run regenerates documents that shouldn't change.

**Diagnostic:**

```bash
# Find out what triggers regeneration of a document
bin/graft uses docs/strategy/foundations.md
```

Output shows which prompts depend on this file:

```
docs/strategy/foundations.md is used by:
  - docs/strategy/exec-summary.prompt.md
  - docs/strategy/recommendations.prompt.md
  - docs/operations/roadmap.prompt.md
```

If too many documents depend on one frequently-changing file, consider:

1. **Split the shared file** - Separate stable content from changing content
2. **Reduce coupling** - Do all those documents really need that dependency?
3. **Use more stable sources** - Depend on curated summaries, not raw notes

### Verify Improvements

**Before optimization:**
```bash
time bin/graft rebuild
# real    3m45s
```

**After optimization:**
```bash
time bin/graft rebuild
# real    1m20s
```

## Getting Help

Before asking for help, gather this diagnostic information:

### 1. Check Your Environment

```bash
# Docker image
docker image ls graft:local

# DVC status
bin/graft status
