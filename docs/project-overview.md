<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=25efdee60f90138c5598f109ffdf2a3e6bea3f0624046650c5bc784c9e1370e4 | rev=4b99e8d | 2025-11-04 -->
# Graft Project Overview

## What is Graft?

Graft is an LLM-powered documentation pipeline that keeps your strategic documents consistent and up-to-date as source materials evolve. Instead of manually rewriting documentation when code, data, or specifications change, you write declarative prompts that tell Claude how to generate documents from dependencies. When sources change, Graft detects exactly what changed and instructs the LLM to apply only the necessary updates—preserving unchanged content byte-for-byte and minimizing both token usage and spurious diffs.

The core innovation is **intelligent change detection**: Graft analyzes git history to distinguish between source material changes and instruction changes, then passes precise directives to Claude about what type of regeneration is needed. This allows you to maintain complex documentation hierarchies where generated documents feed into other documents, creating a dependency graph that automatically propagates updates through multiple levels.

## Key Concepts

### Change Detection

Graft tracks two independent types of changes:

**Source changes**: Detected by running `git diff` on all files listed in a prompt's `deps:` frontmatter. If dependencies have uncommitted changes, Graft generates a unified diff showing exactly what changed in the source material.

**Prompt changes**: Detected by comparing the current prompt body (everything after frontmatter) with the version from the previous commit. If the instruction text differs, Graft generates a unified diff showing what changed in the requirements.

This dual tracking enables precise context delivery to the LLM—Claude receives only the information it needs to apply the correct type of update.

### Actions and Directives

Based on what changed, Graft selects one of five action directives to pass to Claude:

- **GENERATE**: No previous draft exists. Create the complete document from scratch using source content and instructions.

- **UPDATE**: Sources changed but instructions haven't. Apply only the semantic changes from the source diff while keeping all other sections byte-identical. Claude receives the diff and preserves unchanged content exactly.

- **REFINE**: Instructions changed but sources haven't. Review the prompt diff to understand what changed in the requirements, then apply necessary modifications to align the document with updated instructions. Scope varies—a factual correction needs only a line change; a style directive needs broader changes.

- **REFRESH**: Both sources and instructions changed. Review both diffs carefully and apply necessary changes from each, preserving unchanged content where possible.

- **MAINTAIN**: Nothing changed. Output must be byte-identical to previous draft to prevent spurious diffs.

Claude interprets these directives intelligently based on the semantic meaning of changes, the structure of the existing document, and the requirements stated in current instructions.

### Multi-level Documentation DAGs

Generated documents can serve as inputs to other prompts, creating hierarchical documentation where changes cascade automatically. For example:

```
docs/api-reference.md (from source code)
         ↓
docs/user-guide.md (references API structure)
         ↓
docs/overview.md (high-level summary)
```

When source code changes, DVC automatically:
1. Regenerates `api-reference.md` via UPDATE
2. Detects that `user-guide.md` depends on the changed API reference
3. Regenerates `user-guide.md` via UPDATE
4. Detects that `overview.md` depends on both changed files
5. Regenerates `overview.md` via UPDATE

DVC manages this efficiently through its dependency graph, executing only stages with changed dependencies and running independent stages in parallel.

### Auto-generated dvc.yaml

The `dvc.yaml` file defining the pipeline is automatically generated by scanning for `*.prompt.md` files. Each prompt becomes a DVC stage named after its output path. The generation process:

1. Finds all `.prompt.md` files recursively
2. Extracts YAML frontmatter (output path, dependencies, model parameters)
3. Creates a DVC stage with appropriate commands and dependencies
4. Includes `scripts/pack_prompt.py` as a dependency (changes to change detection logic affect all outputs)
5. Writes complete pipeline definition with model parameters

**Never edit `dvc.yaml` manually**—it will be overwritten. All changes come from modifying `.prompt.md` files, then running `bin/graft sync` to regenerate the pipeline definition.

A pre-commit git hook ensures `dvc.yaml` stays synchronized with prompt files, preventing commits with outdated pipeline definitions.

## Quick Start

### Prerequisites

- Docker installed and running
- AWS credentials with access to Amazon Bedrock
- Claude Sonnet 4.5 enabled in your AWS Bedrock account (model: `anthropic.claude-3-5-sonnet-20241022-v2:0`)

Verify access: `aws bedrock list-foundation-models --region us-east-1`

### Installation

Clone and build the Docker image:

```bash
git clone https://github.com/yourusername/graft.git
cd graft
make build
```

This creates a `graft:local` Docker image with all dependencies bundled.

### Set Up Your Project

Create a new documentation project:

```bash
mkdir my-docs
cd my-docs
```

Configure AWS credentials (choose one method):

**Option 1: Mounted credentials (recommended)**

If you have AWS SSO or profiles configured:

```bash
aws sso login --profile your-profile
```

**Option 2: Environment variables**

```bash
cp /path/to/graft/.env.example .env
# Edit .env and set:
# AWS_REGION=***
# AWS_DEFAULT_REGION=***
```

Initialize the DVC pipeline:

```bash
/path/to/graft/bin/graft init
```

### Create Your First Document

Create source material:

```bash
mkdir -p docs/general
cat > docs/general/features.md <<EOF
# Core Features

- **Automatic Updates**: Documents regenerate when dependencies change
- **Smart Diffing**: Only changed content is sent to the LLM
- **Version Control**: Full DVC integration for reproducibility
- **AWS Bedrock**: Powered by Claude Sonnet 4.5
EOF
```

Scaffold a prompt:

```bash
/path/to/graft/bin/graft new product-overview general
```

Edit `docs/general/product-overview.prompt.md`:

```markdown
---
deps:
  - docs/general/features.md
---
# Product Overview — Prompt

You are maintaining a strategic document. You will receive a CHANGE ANALYSIS 
that tells you exactly what changed.

For UPDATE: Apply ONLY the semantic changes from SOURCE DIFF. Keep all 
unchanged sections byte-identical.

Write a concise product overview that:
- Starts with a one-sentence value proposition
- Summarizes key features in accessible language
- Explains who would benefit from using this tool
- Keeps the tone professional but approachable

Keep the overview to 2-3 paragraphs maximum.
```

Generate the document:

```bash
/path/to/graft/bin/graft rebuild
```

View your generated document:

```bash
cat docs/general/product-overview.md
```

### Iterate

Make a change to dependencies:

```bash
echo "- **Docker-based**: No local dependencies to install" >> docs/general/features.md
```

Regenerate:

```bash
/path/to/graft/bin/graft rebuild
git diff docs/general/product-overview.md
```

The diff shows only relevant changes. Graft detected the source change and instructed Claude to apply an UPDATE—preserving all unchanged content exactly.

## Common Workflows

### Add a New Document

```bash
# 1. Scaffold the prompt file
bin/graft new quarterly-review strategy

# 2. Edit the generated file
vim docs/strategy/quarterly-review.prompt.md
# - Update deps: to list source files
# - Write prompt instructions

# 3. Generate the document
bin/graft rebuild
```

### Update Dependencies

```bash
# 1. Edit prompt frontmatter
vim docs/strategy/exec-summary.prompt.md
# Add to deps:
#   - docs/research/market-analysis.md

# 2. Regenerate dvc.yaml
bin/graft sync

# 3. Run pipeline
bin/graft rebuild
```

### Debug Generation Issues

```bash
# 1. Generate the packed prompt
bin/graft diff exec_summary

# 2. Review the output
cat build/exec_summary.promptpack.txt
# Check:
# - Is the action directive correct?
# - Are all dependencies included?
# - Do the diffs show expected changes?

# 3. Fix and regenerate
vim docs/strategy/exec-summary.prompt.md
bin/graft sync
bin/graft rebuild
```

### Check Impact Before Editing

```bash
# 1. Check which prompts depend on a file
bin/graft uses docs/strategy/foundations.md

# 2. Decide if the scope is acceptable
# 3. Make your edit
vim docs/strategy/foundations.md

# 4. Verify what will run
bin/graft status

# 5. Regenerate affected documents
bin/graft rebuild
```

### Structure Documentation Hierarchies

Create a three-level hierarchy:

```
docs/
├── api-reference.prompt.md
│   deps: ["src/**/*.py"]
├── user-guide.prompt.md
│   deps: ["docs/api-reference.md", "examples/**/*.py"]
└── overview.prompt.md
    deps: ["docs/api-reference.md", "docs/user-guide.md"]
```

When `src/api.py` changes, DVC automatically cascades updates through all three levels.

## Configuration Essentials

### AWS Credentials

Graft supports multiple authentication methods in priority order:

1. **AWS directory mount** (recommended): `~/.aws` is mounted read-only, supporting profiles and SSO
2. **Environment variables**: Credentials from host environment are passed through
3. **`.env` file**: Project-specific credentials loaded from `.env`

For SSO workflows:

```bash
aws sso login --profile your-profile
```

For explicit credentials, edit `.env`:

```
AWS_REGION=***
AWS_DEFAULT_REGION=***
AWS_ACCESS_KEY_ID=***
AWS_SECRET_ACCESS_KEY=***
```

### Model Selection

The default model is `bedrock-claude-v4.5-sonnet-us` (Claude Sonnet 4.5 via US cross-region inference profile).

Override per-document in frontmatter:

```yaml
---
model: bedrock-claude-v4.5-opus-us
deps:
  - docs/strategy/foundations.md
---
```

Available models:
- `bedrock-claude-v4.5-sonnet-us` - Default, best for most docs
- `bedrock-claude-v4.5-opus-us` - Maximum quality
- `bedrock-claude-v4.5-haiku-us` - Speed/lower cost

### Dependency Specification

Dependencies are declared in prompt frontmatter:

```yaml
---
deps:
  - data/config.json              # Manual source
  - docs/api-reference.md         # Generated doc (creates DAG)
  - ../sibling-repo/README.md     # Files outside docs/
---
```

Rules:
- Paths are relative to the `.prompt.md` file location
- Absolute paths are supported
- Generated docs (`.md` files) create build order dependencies
- Source files are tracked for changes but don't affect build order
- Files are included in the prompt in the order listed

## Troubleshooting Highlights

### Nothing Regenerated

**Symptom**: `bin/graft rebuild` runs but no documents regenerate.

**Cause**: The file you changed isn't listed in any `deps:` frontmatter.

**Solution**:

```bash
# Check which prompts depend on a file
bin/graft uses docs/strategy/foundations.md

# If empty, add the dependency
vim docs/strategy/exec-summary.prompt.md
# Add to deps:
#   - docs/strategy/foundations.md

# Regenerate
bin/graft sync
bin/graft rebuild
```

### AWS Authentication Errors

**Symptom**: `ExpiredToken` or `UnrecognizedClientException` errors.

**Cause**: AWS credentials expired or missing Bedrock permissions.

**Solution**:

For expired SSO:
```bash
aws sso login
bin/graft rebuild
```

For missing permissions, ensure your IAM user/role has:
```json
{
  "Effect": "Allow",
  "Action": [
    "bedrock:InvokeModel",
    "bedrock:InvokeModelWithResponseStream"
  ],
  "Resource": "arn:aws:bedrock:*::foundation-model/*"
}
```

### Large Unexpected Diffs

**Symptom**: Small source changes produce large document rewrites.

**Cause**: Prompt instructions don't emphasize preservation.

**Solution**: Add explicit preservation instructions to your prompt:

```markdown
For UPDATE: Apply ONLY the semantic changes from SOURCE DIFF. Keep all 
unchanged sections byte-identical. Only modify content where the source 
diff implies a semantic change. Preserve formatting, style, and wording 
of unchanged sections exactly.
```

### Dependency Errors

**Symptom**: `file 'docs/strategy/missing.md' does not exist`

**Solution**: Either create the file or remove it from dependencies:

```yaml
---
deps:
  - docs/strategy/foundations.md
  # - docs/strategy/missing.md  # Removed
---
```

Then regenerate: `bin/graft sync && bin/graft rebuild`

For more detailed troubleshooting, see [troubleshooting.md](troubleshooting.md).

## This Document Itself

This overview was generated by Graft from the source documents `command-reference.md`, `configuration.md`, `getting-started.md`, `how-it-works.md`, and `troubleshooting.md`. It demonstrates Graft's ability to synthesize multiple sources into coherent, structured documentation that maintains consistency with the underlying materials.

When the source documentation changes—whether through factual updates, structural reorganizations, or new sections—this overview will automatically regenerate with only the necessary changes, preserving the overall structure and style while incorporating new information. This is the UPDATE action in practice: semantic changes from sources are applied surgically while unchanged content remains byte-identical.
