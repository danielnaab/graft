<!-- Generated by Graft | model=bedrock-claude-v4.5-sonnet-us | sig=116cc5eaf2aa04b864f17cdcf5f45be37fb108627a19869b50e634cc5126218e | rev=16b2c01 | 2025-11-04 -->
# Graft Project Overview

## What is Graft?

Graft is an LLM-powered documentation pipeline that keeps your documents consistent and up-to-date as your source materials evolve. Instead of manually rewriting documentation when requirements, code, or data change, Graft intelligently detects what changed and uses Claude to update only the affected sections—preserving unchanged content exactly. It combines git-based change detection, DVC pipeline orchestration, and smart diff-based prompting to create a reproducible, version-controlled documentation system that scales from simple README files to complex multi-level documentation hierarchies.

## Key Concepts

### Change Detection

Graft tracks two independent types of changes to determine how documentation should regenerate:

**Source changes** are detected by running `git diff` on all files listed in a prompt's `deps:` frontmatter. When dependencies like code, data files, or other documents change, Graft generates a unified diff showing exactly what changed in the source material.

**Prompt changes** are detected by comparing the current prompt instructions with the version from the previous commit. When your requirements, structure, or presentation guidelines change, Graft generates a diff showing what changed in the instructions themselves.

This separation allows Graft to provide precise context to the LLM about what changed and why regeneration is needed.

### Actions

Based on what changed, Graft selects one of five actions that tell Claude how to update the document:

- **GENERATE**: No previous draft exists—create the full document from scratch using source content and instructions
- **UPDATE**: Sources changed but instructions haven't—apply only the semantic changes from the source diff while keeping all other sections byte-identical
- **REFINE**: Instructions changed but sources haven't—review the prompt diff and apply only the necessary modifications to align the document with updated guidance (scope depends on the nature of changes: a factual correction requires a line change, a style directive requires broader changes)
- **REFRESH**: Both sources and instructions changed—apply necessary changes from both diffs while preserving unchanged content
- **MAINTAIN**: Nothing changed—output must be byte-identical to previous draft

These actions are passed to Claude via a system message along with relevant diffs, the previous draft, and full source content. Claude interprets them intelligently based on the semantic meaning of changes.

### Multi-level Documentation DAGs

Graft supports hierarchical documentation where generated documents become inputs to other prompts, creating a directed acyclic graph (DAG) of dependencies. A prompt's `deps:` section can reference any file tracked in git, including outputs from other prompts. DVC automatically understands these relationships and manages cascading updates.

**Example hierarchy:**

```
docs/api-reference.md (generated from source code)
         ↓
docs/user-guide.md (references API structure)
         ↓
docs/overview.md (high-level summary)
```

If `src/api.py` changes, DVC detects the dependency chain and regenerates all three documents in order, passing appropriate UPDATE actions at each level.

### Auto-generated dvc.yaml

The `dvc.yaml` file defining the pipeline is automatically generated by scanning for `*.prompt.md` files. Each prompt becomes a DVC stage with its dependencies, output location, and model parameters extracted from frontmatter. This ensures the pipeline definition stays synchronized with prompt declarations—you never edit `dvc.yaml` manually.

## Quick Start

### Prerequisites

- Docker installed and running
- AWS credentials with access to Amazon Bedrock
- Claude Sonnet 4.5 enabled in your AWS Bedrock account

Verify access: `aws bedrock list-foundation-models --region us-east-1`

### Installation

Clone and build Graft:

```bash
git clone https://github.com/yourusername/graft.git
cd graft
make build
```

Set up your project:

```bash
mkdir my-docs
cd my-docs
```

Configure AWS credentials (Graft automatically mounts `~/.aws` or you can use environment variables):

```bash
aws sso login --profile your-profile
# Or copy .env.example and configure explicit credentials
```

Initialize Graft:

```bash
/path/to/graft/bin/graft init
```

### Create Your First Document

Scaffold a new prompt:

```bash
/path/to/graft/bin/graft new product-overview general
```

Create a source document with features:

```bash
mkdir -p docs/general
cat > docs/general/features.md <<EOF
# Core Features
- **Automatic Updates**: Documents regenerate when dependencies change
- **Smart Diffing**: Only changed content is sent to the LLM
- **Version Control**: Full DVC integration for reproducibility
EOF
```

Edit `docs/general/product-overview.prompt.md` to reference the features and define how to generate the overview:

```markdown
---
deps:
  - docs/general/features.md
---
# Product Overview — Prompt

Create a concise product overview for Graft that:
- Starts with a one-sentence value proposition
- Summarizes key features in accessible language
- Explains who would benefit from using this tool

Keep it to 2-3 paragraphs maximum.
```

Generate the document:

```bash
/path/to/graft/bin/graft rebuild
```

View your generated overview:

```bash
cat docs/general/product-overview.md
```

### Iterate on Documents

**When you edit source files**, Graft sends only the diff to Claude:

```bash
echo "- **Docker-based**: No local dependencies" >> docs/general/features.md
/path/to/graft/bin/graft rebuild
```

Claude receives an UPDATE action with the source diff and updates only affected sections.

**When you edit prompt instructions**, Graft regenerates using updated guidance:

```bash
# Edit product-overview.prompt.md to change tone or structure
/path/to/graft/bin/graft rebuild
```

Claude receives a REFINE action and applies your new instructions.

## Common Workflows

### Add a New Document

```bash
# 1. Create prompt file
bin/graft new quarterly-review strategy

# 2. Edit to add dependencies and instructions
vim docs/strategy/quarterly-review.prompt.md

# 3. Generate
bin/graft rebuild
```

### Check Impact Before Editing

```bash
# See which documents depend on a file
bin/graft uses docs/strategy/foundations.md

# Shows: foundations.md is used by:
#   - docs/strategy/exec-summary.prompt.md
#   - docs/strategy/recommendations.prompt.md

# Check what would run
bin/graft status

# Make changes and regenerate
bin/graft rebuild
```

### Debug Generation Issues

```bash
# Inspect the complete packed prompt sent to Claude
bin/graft diff exec_summary

# Review the output
cat build/exec_summary.promptpack.txt
# Check: action directive, included dependencies, diffs, previous draft
```

### Structure Documentation Hierarchies

Create layered documentation where high-level docs depend on detailed docs:

```
docs/
├── technical/
│   ├── architecture.prompt.md
│   │   deps: ["src/**/*.py"]
│   │   out: architecture.md
│   └── api-reference.prompt.md
│       deps: ["src/**/*.py"]
│       out: api-reference.md
└── user/
    ├── user-guide.prompt.md
    │   deps: ["docs/technical/architecture.md", "examples/**/*.py"]
    │   out: user-guide.md
    └── overview.prompt.md
        deps: ["docs/technical/architecture.md", "docs/user/user-guide.md"]
        out: overview.md
```

Changes to source code cascade through the hierarchy automatically.

## Configuration Essentials

### AWS Credentials

Graft supports three credential methods:

1. **AWS directory mount** (recommended): `~/.aws` automatically mounted, supports profiles and SSO
2. **Environment variables**: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` passed from host
3. **`.env` file**: Project-specific credentials

Priority: environment variables > `.env` file > AWS directory.

### Model Selection

Override the default model in prompt frontmatter:

```yaml
---
model: bedrock-claude-v4.5-sonnet-us
max_tokens: 16000
temperature: 1.0
deps:
  - docs/sources.md
---
```

Supported models:
- `bedrock-claude-v4.5-sonnet-us` (default, Claude Sonnet 4.5)
- `bedrock-claude-v3.5-sonnet` (Claude Sonnet 3.5)

### Dependency Specification

Dependencies in `deps:` can be:

- **Explicit paths**: `docs/strategy/foundations.md`
- **Globs**: `src/**/*.py`
- **Generated documents**: `docs/api-reference.md` (from other prompts)

Graft uses git tracking, so only committed files are recognized as dependencies. Globs expand at pipeline generation time.

### Docker Execution

All commands run in Docker for consistency. The `bin/graft` wrapper:
- Mounts your working directory and credentials
- Passes environment variables
- Executes commands in the controlled `graft:local` container

From your perspective, `bin/graft` behaves like a native command.

## Troubleshooting Highlights

### Nothing Regenerated

**Symptom:** `bin/graft rebuild` runs but no documents update.

**Cause:** Changed files aren't listed in `deps:` frontmatter.

**Solution:**

```bash
# Check which prompts use a file
bin/graft uses docs/strategy/foundations.md

# Add missing dependencies to prompt frontmatter
vim docs/strategy/exec-summary.prompt.md
# Add to deps: ["docs/strategy/foundations.md"]

# Update pipeline and regenerate
bin/graft sync
bin/graft rebuild
```

### AWS Authentication Errors

**Symptom:** `ExpiredToken` or `UnrecognizedClientException` errors.

**Solution for expired SSO:**

```bash
aws sso login
bin/graft rebuild
```

**Solution for missing permissions:**

Your AWS user/role needs `bedrock:InvokeModel` permission for `arn:aws:bedrock:*::foundation-model/*`.

**Solution for wrong region:**

Update `.env`:

```bash
AWS_DEFAULT_REGION=us-east-1  # Claude models available here
```

### Large Unexpected Diffs

**Symptom:** Small source changes cause large rewrites in generated docs.

**Cause:** Prompt doesn't have explicit preservation instructions.

**Solution:** Add preservation guidance to your prompt:

```markdown
You are maintaining a strategic document. Follow the action directive:
- UPDATE: Apply ONLY semantic changes from SOURCE DIFF, keep unchanged sections byte-identical
- REFINE: Apply only necessary changes from PROMPT DIFF based on semantic scope
- MAINTAIN: Output must be identical to previous draft

Preserve formatting, style, and wording of unchanged sections exactly.
```

### Dependency Errors

**Symptom:** `Dependency 'docs/missing.md' does not exist` or circular dependency detected.

**Solution for missing files:** Remove from `deps:` or create the file.

**Solution for circular dependencies:** Restructure to be hierarchical:

```
✅ Good:
foundations.md (base)
  ↓
exec-summary.md (depends on foundations)
  ↓
recommendations.md (depends on both)

❌ Bad:
exec-summary.md → foundations.md → exec-summary.md (cycle)
```

## This Document Itself

This overview was generated by Graft from four source documents: `getting-started.md`, `how-it-works.md`, `command-reference.md`, `configuration.md`, and `troubleshooting.md`. It demonstrates Graft's ability to synthesize multiple sources into coherent, focused documentation—exactly the kind of task Graft excels at. The complete prompt that generated this document is tracked in version control alongside the sources, making this overview reproducible and automatically updatable as the source documentation evolves.
