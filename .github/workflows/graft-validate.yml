name: Validate Graft Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.prompt.md'
      - '**.md'
      - 'dvc.yaml'
      - 'dvc.lock'
      - 'scripts/**'
  push:
    branches: [main]
    paths:
      - '**.prompt.md'
      - '**.md'
      - 'dvc.yaml'

concurrency:
  group: graft-validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for change detection

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Graft image
        run: make build

      - name: Validate DVC pipeline synchronization
        id: dvc-sync
        run: |
          echo "Checking if dvc.yaml is synchronized with prompt files..."

          # Generate dvc.yaml in a temp location
          GRAFT_DIR=. bin/graft sync > /tmp/sync.log 2>&1 || true

          # Check if dvc.yaml changed
          if ! git diff --quiet dvc.yaml; then
            echo "âŒ ERROR: dvc.yaml is not synchronized with prompt files"
            echo ""
            echo "The following changes are needed:"
            git diff dvc.yaml
            echo ""
            echo "Fix: Run 'bin/graft sync' locally and commit the changes"
            exit 1
          fi

          echo "âœ… dvc.yaml is synchronized"

      - name: Validate prompt files
        id: check-deps
        run: |
          echo "Validating prompt file structure and dependencies..."

          # Run Python validation script (checks frontmatter, deps, cycles)
          if python3 scripts/validate.py --verbose; then
            echo "âœ… All prompt files validated successfully"
          else
            echo "âŒ Validation failed - see errors above"
            echo ""
            echo "Fix: Address the validation errors and commit the changes"
            exit 1
          fi

      - name: Check for stale documentation
        id: check-stale
        run: |
          echo "Checking for stale generated documentation..."

          # Run DVC status to see what needs regeneration
          status_output=$(GRAFT_DIR=. bin/graft status 2>&1 || true)

          # Check if there are any changed stages
          if echo "$status_output" | grep -q "changed"; then
            echo "âŒ ERROR: Generated documentation is stale"
            echo ""
            echo "$status_output"
            echo ""
            echo "The following documentation needs regeneration:"
            echo "$status_output" | grep "changed" || true
            echo ""
            echo "Fix: Run 'bin/graft rebuild' locally and commit the regenerated files"
            exit 1
          fi

          echo "âœ… All documentation is up to date"

      - name: Validation Summary
        if: always()
        run: |
          echo "## Graft Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dvc-sync.outcome }}" == "success" ]; then
            echo "âœ… DVC pipeline synchronized" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ DVC pipeline not synchronized" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.check-deps.outcome }}" == "success" ]; then
            echo "âœ… Prompt files validated (frontmatter, deps, cycles)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Prompt validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.check-stale.outcome }}" == "success" ]; then
            echo "âœ… Documentation up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Stale documentation detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dvc-sync.outcome }}" == "success" ] && \
             [ "${{ steps.check-deps.outcome }}" == "success" ] && \
             [ "${{ steps.check-stale.outcome }}" == "success" ]; then
            echo "ðŸŽ‰ All validation checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Validation failed. See logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
