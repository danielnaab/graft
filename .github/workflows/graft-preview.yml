name: Preview Graft Documentation

# Trigger when 'preview-docs' label is added to PR
on:
  pull_request:
    types: [labeled]

# Only run if the label is 'preview-docs'
jobs:
  preview:
    if: github.event.label.name == 'preview-docs'
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Allow time for regeneration

    permissions:
      contents: read
      pull-requests: write  # Need to post comments

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # Full history for change detection

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Graft image
        run: make build

      - name: Check what needs regeneration
        id: check-status
        run: |
          # Check which docs are stale
          status_output=$(GRAFT_DIR=. bin/graft status 2>&1 || true)

          if echo "$status_output" | grep -q "changed"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Count stages
            stage_count=$(echo "$status_output" | grep -c "changed" || echo "0")
            echo "stage_count=$stage_count" >> $GITHUB_OUTPUT

            # Extract stage names
            stages=$(echo "$status_output" | grep "changed" | awk '{print $1}' | tr '\n' ',' | sed 's/,$//')
            echo "stages=$stages" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "stage_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Post initial comment
        if: steps.check-status.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const stageCount = '${{ steps.check-status.outputs.stage_count }}';
            const stages = '${{ steps.check-status.outputs.stages }}'.split(',').join(', ');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìù Documentation Preview Started

Regenerating ${stageCount} document(s): ${stages}

This will take approximately ${Math.ceil(stageCount * 0.75)} minutes. Preview will be posted when complete.

‚è≥ Regenerating...`
            });

      - name: Regenerate documentation
        if: steps.check-status.outputs.has_changes == 'true'
        id: regenerate
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
        run: |
          echo "Starting regeneration at $(date)"
          start_time=$(date +%s)

          # Run regeneration
          GRAFT_DIR=. bin/graft rebuild > /tmp/regen.log 2>&1 || {
            echo "regeneration_failed=true" >> $GITHUB_OUTPUT
            exit 1
          }

          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "duration=$duration" >> $GITHUB_OUTPUT
          echo "Completed in ${duration} seconds"

      - name: Capture changes
        if: steps.check-status.outputs.has_changes == 'true' && steps.regenerate.outputs.regeneration_failed != 'true'
        id: capture-changes
        run: |
          # Get list of changed markdown files
          changed_files=$(git diff --name-only --diff-filter=M | grep '\.md$' || true)

          if [ -z "$changed_files" ]; then
            echo "has_diffs=false" >> $GITHUB_OUTPUT
          else
            echo "has_diffs=true" >> $GITHUB_OUTPUT

            # Count changed files
            file_count=$(echo "$changed_files" | wc -l)
            echo "file_count=$file_count" >> $GITHUB_OUTPUT

            # Generate diff summary (truncated for comment size limits)
            mkdir -p /tmp/diffs
            echo "$changed_files" | while read file; do
              if [ -n "$file" ]; then
                echo "### \`$file\`" >> /tmp/diffs/summary.md
                echo '```diff' >> /tmp/diffs/summary.md

                # Get diff stats
                stats=$(git diff --stat "$file")
                echo "<!-- $stats -->" >> /tmp/diffs/summary.md

                # Get actual diff (limit to first 50 lines to avoid huge comments)
                git diff "$file" | head -100 >> /tmp/diffs/summary.md

                lines=$(git diff "$file" | wc -l)
                if [ "$lines" -gt 100 ]; then
                  echo "..." >> /tmp/diffs/summary.md
                  echo "<!-- Diff truncated (total: $lines lines) -->" >> /tmp/diffs/summary.md
                fi

                echo '```' >> /tmp/diffs/summary.md
                echo "" >> /tmp/diffs/summary.md
              fi
            done
          fi

      - name: Estimate cost
        if: steps.check-status.outputs.has_changes == 'true' && steps.regenerate.outputs.regeneration_failed != 'true'
        id: estimate-cost
        run: |
          # Rough cost estimation: ~$0.05 per document (conservative)
          stage_count=${{ steps.check-status.outputs.stage_count }}
          estimated_cost=$(echo "scale=2; $stage_count * 0.05" | bc)
          echo "estimated_cost=$estimated_cost" >> $GITHUB_OUTPUT

      - name: Post preview comment
        if: steps.check-status.outputs.has_changes == 'true' && steps.regenerate.outputs.regeneration_failed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const stageCount = '${{ steps.check-status.outputs.stage_count }}';
            const fileCount = '${{ steps.capture-changes.outputs.file_count }}';
            const duration = '${{ steps.regenerate.outputs.duration }}';
            const cost = '${{ steps.estimate-cost.outputs.estimated_cost }}';
            const hasDiffs = '${{ steps.capture-changes.outputs.has_diffs }}';

            let diffContent = '';
            if (hasDiffs === 'true' && fs.existsSync('/tmp/diffs/summary.md')) {
              diffContent = fs.readFileSync('/tmp/diffs/summary.md', 'utf8');

              // Truncate if too long (GitHub comment limit is ~65k chars)
              if (diffContent.length > 60000) {
                diffContent = diffContent.substring(0, 60000) + '\n\n...\n\n*Preview truncated due to size. Run `bin/graft rebuild` locally to see full changes.*';
              }
            }

            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

            let body = `## ‚úÖ Documentation Preview Complete

**Summary:**
- üìÑ Documents regenerated: ${stageCount}
- üìù Files changed: ${fileCount}
- ‚è±Ô∏è Time: ${timeStr}
- üí∞ Estimated cost: ~$${cost}

`;

            if (hasDiffs === 'true') {
              body += `### Changes Preview

${diffContent}

---

**Next Steps:**
- Review the changes above
- If they look good, run \`bin/graft rebuild\` locally and commit
- Or re-trigger this preview after updating prompts/sources

`;
            } else {
              body += `### No Changes

Regeneration completed but produced no changes to the documentation. This means the committed docs already match what regeneration would produce.

`;
            }

            body += `<details>
<summary>How to apply these changes</summary>

\`\`\`bash
# Regenerate locally
bin/graft rebuild

# Review changes
git diff docs/

# Commit
git add docs/
git commit -m "Regenerate documentation"
git push
\`\`\`

</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Post failure comment
        if: steps.regenerate.outputs.regeneration_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let logContent = '';

            if (fs.existsSync('/tmp/regen.log')) {
              logContent = fs.readFileSync('/tmp/regen.log', 'utf8');
              // Last 100 lines
              logContent = logContent.split('\n').slice(-100).join('\n');
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Documentation Preview Failed

Regeneration encountered an error. Check the workflow logs for details.

<details>
<summary>Error log (last 100 lines)</summary>

\`\`\`
${logContent}
\`\`\`

</details>

**Common issues:**
- AWS credentials not configured (check repository secrets)
- Missing dependencies in prompt files
- LLM API failures or rate limits

Check the [Actions tab](${context.payload.repository.html_url}/actions/runs/${context.runId}) for full logs.`
            });

      - name: Post no-changes comment
        if: steps.check-status.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ÑπÔ∏è Documentation Preview: No Changes Detected

All documentation is already up to date. No regeneration needed.

The committed documentation matches all sources and prompts.`
            });
